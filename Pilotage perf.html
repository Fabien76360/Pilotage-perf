<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Production - Pilotage Atelier</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #0f172a;
      --card: rgba(30, 41, 59, 0.8);
      --card-light: rgba(51, 65, 85, 0.6);
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.2);
      --glass: rgba(255, 255, 255, 0.05);
      --glow: rgba(99, 102, 241, 0.3);
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header moderne */
    header {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2rem;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.75rem;
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .view-tabs {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-active {
      box-shadow: 0 0 0 2px var(--primary);
    }

    .btn {
      padding: 0.65rem 1.25rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(99, 102, 241, 0.6);
    }

    .btn-secondary {
      background: var(--card-light);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--glass);
      border-color: var(--primary);
    }

    /* Container principal */
    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      gap: 2rem;
    }

    /* KPI Cards avec glassmorphism */
    .kpi-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .kpi-card {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.6s ease;
    }

    .kpi-card:hover::before {
      transform: scaleX(1);
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: var(--primary);
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .kpi-title {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .kpi-icon {
      font-size: 2rem;
      filter: drop-shadow(0 0 10px currentColor);
    }

    .kpi-value {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .kpi-trend {
      font-size: 0.85rem;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .kpi-trend.negative {
      color: var(--danger);
    }

    /* Badges et achievements */
    .badges-section {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .badges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .badge {
      background: var(--card-light);
      border-radius: 1rem;
      padding: 1.5rem 1rem;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .badge.unlocked {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .badge-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      filter: grayscale(100%);
      opacity: 0.3;
    }

    .badge.unlocked .badge-icon {
      filter: grayscale(0%);
      opacity: 1;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .badge-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .badge.unlocked .badge-label {
      color: var(--success);
    }

    /* Page op√©rateur monocolonne */
    .oee-operator-wrapper {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(260px, 360px);
      gap: 2rem;
      align-items: flex-start;
    }

    @media (max-width: 1200px) {
      .oee-operator-wrapper {
        grid-template-columns: 1fr;
      }

      .oee-operator-recap {
        position: relative;
        top: 0;
      }
    }

    .oee-operator-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .oee-operator-column-header {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1.5rem;
      min-height: 72px;
    }

    .oee-operator-column-header-left {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .oee-operator-team-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .oee-operator-team-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .oee-operator-team-select {
      background: var(--card-light);
      border: 1px solid var(--border);
      border-radius: 0.9rem;
      color: var(--text);
      padding: 0.5rem 1rem;
      min-height: 44px;
      font-weight: 600;
      cursor: pointer;
    }

    .oee-operator-team-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--glow);
    }

    .oee-operator-team-oee {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
      min-width: 140px;
    }

    .oee-operator-team-oee span {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .oee-operator-team-oee strong {
      font-size: 1.6rem;
      font-weight: 700;
    }

    .oee-operator-hours {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .oee-operator-tile {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      overflow: hidden;
      position: relative;
      transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
    }

    .oee-operator-tile.oee-operator-active {
      border-color: var(--primary);
      box-shadow: 0 0 25px rgba(99, 102, 241, 0.25);
    }

    .oee-operator-tile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1.25rem 1.5rem;
      cursor: pointer;
      min-height: 88px;
    }

    .oee-operator-tile-header:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .oee-operator-tile-info {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }

    .oee-operator-time {
      font-weight: 700;
      font-size: 1.4rem;
      min-width: 72px;
    }

    .oee-operator-team-name {
      font-size: 0.8rem;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .oee-operator-metrics {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.35rem;
      min-width: 160px;
    }

    .oee-operator-metric-value {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .oee-operator-metric-breakdown {
      display: flex;
      gap: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .oee-operator-summary {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 220px;
    }

    .oee-operator-empty-label {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .oee-operator-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .oee-operator-badge {
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      color: var(--text);
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      min-height: 32px;
    }

    .oee-operator-badge-action {
      border: none;
      cursor: pointer;
    }

    .oee-operator-badge-action:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .oee-operator-causes-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .oee-operator-actions-inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .oee-operator-quick-edit {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.5rem;
    }

    .oee-operator-quick-edit input {
      width: 140px;
      min-height: 40px;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--card-light);
      color: var(--text);
      font-weight: 600;
      padding: 0.4rem 0.75rem;
    }

    .oee-operator-quick-edit button {
      min-height: 40px;
      padding: 0.4rem 0.9rem;
      border-radius: 0.75rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    .oee-operator-quick-edit button:first-of-type {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
    }

    .oee-operator-quick-edit button:last-of-type {
      background: var(--card-light);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .oee-operator-icon-button {
      min-height: 44px;
      min-width: 44px;
      border-radius: 0.75rem;
      background: var(--card-light);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 1.1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .oee-operator-icon-button:hover {
      background: var(--glass);
      border-color: var(--primary);
    }

    .oee-operator-tile-body {
      display: none;
      border-top: 1px solid var(--border);
      padding: 1.5rem;
      background: rgba(15, 23, 42, 0.6);
    }

    .oee-operator-tile.oee-operator-open .oee-operator-tile-body {
      display: block;
    }

    .oee-operator-input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .oee-operator-number-field {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .oee-operator-number-field input[type="number"] {
      width: 160px;
      min-height: 44px;
      border-radius: 0.9rem;
      background: var(--card-light);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 1.1rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
    }

    .oee-operator-number-field input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--glow);
    }

    .oee-operator-step {
      min-width: 44px;
      min-height: 44px;
      border-radius: 0.9rem;
      border: 1px solid var(--border);
      background: var(--card-light);
      color: var(--text);
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .oee-operator-step:hover {
      background: var(--glass);
      border-color: var(--primary);
    }

    .oee-operator-minutes {
      margin-bottom: 1.5rem;
    }

    .oee-operator-minutes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    .oee-operator-minutes-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.25);
      overflow: hidden;
    }

    .oee-operator-minutes-progress {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 0%;
      border-radius: inherit;
      transition: width 0.2s ease;
    }

    .oee-minutes-green { background: rgba(16, 185, 129, 0.8); }
    .oee-minutes-orange { background: rgba(245, 158, 11, 0.9); }
    .oee-minutes-red { background: rgba(239, 68, 68, 0.95); }

    .oee-operator-accordion {
      border-radius: 1rem;
      overflow: hidden;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .oee-accordion-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: rgba(15, 23, 42, 0.6);
      border: none;
      color: var(--text);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 52px;
    }

    .oee-accordion-header span {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .oee-accordion-panel {
      display: none;
      padding: 1.25rem;
      background: rgba(30, 41, 59, 0.75);
    }

    .oee-accordion-open .oee-accordion-panel {
      display: block;
    }

    .oee-accordion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .oee-accordion-subcategory {
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1rem;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .oee-accordion-subcategory strong {
      font-size: 0.95rem;
    }

    .oee-accordion-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .oee-accordion-minute-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .oee-operator-recent {
      margin-bottom: 1.5rem;
    }

    .oee-operator-recent-title {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .oee-operator-recent-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .oee-operator-recap-list {
      margin-top: 0.75rem;
      display: grid;
      gap: 0.5rem;
      counter-reset: oee-top;
    }

    .oee-operator-recap-list li {
      padding: 0.65rem 0.85rem;
      background: rgba(148, 163, 184, 0.12);
      border-radius: 0.85rem;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      color: var(--text);
    }

    .oee-operator-recap-list li span {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .oee-operator-selected-causes {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .oee-operator-selected-causes ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .oee-operator-selected-causes li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      padding: 0.6rem 0.85rem;
      border-radius: 0.85rem;
      background: rgba(148, 163, 184, 0.12);
      font-size: 0.9rem;
    }

    .oee-operator-remove {
      background: transparent;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 1rem;
      min-width: 32px;
      min-height: 32px;
    }

    .oee-operator-comment {
      margin-top: 1.5rem;
      background: rgba(15, 23, 42, 0.55);
      border-radius: 1rem;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .oee-operator-comment summary {
      cursor: pointer;
      list-style: none;
      padding: 1rem 1.25rem;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.6);
    }

    .oee-operator-comment textarea {
      width: 100%;
      min-height: 120px;
      border: none;
      padding: 1rem 1.25rem;
      background: transparent;
      color: var(--text);
      resize: vertical;
      font-size: 0.95rem;
    }

    .oee-operator-comment textarea:focus {
      outline: none;
    }

    .oee-operator-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .oee-operator-primary,
    .oee-operator-secondary {
      min-height: 44px;
      padding: 0.75rem 1.5rem;
      border-radius: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .oee-operator-primary {
      background: linear-gradient(135deg, var(--success) 0%, rgba(16, 185, 129, 0.8) 100%);
      color: #0b1f16;
    }

    .oee-operator-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
    }

    .oee-operator-secondary {
      background: var(--card-light);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .oee-operator-secondary:hover {
      background: var(--glass);
      border-color: var(--primary);
    }

    .oee-operator-warning {
      margin-top: 1rem;
      color: var(--warning);
      font-size: 0.85rem;
    }

    .oee-operator-tile.oee-operator-valid-high {
      border-left: 4px solid var(--success);
    }

    .oee-operator-tile.oee-operator-valid-medium {
      border-left: 4px solid var(--warning);
    }

    .oee-operator-tile.oee-operator-valid-low {
      border-left: 4px solid var(--danger);
    }

    .oee-operator-tile.oee-operator-open {
      transform: translateY(-2px);
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.5);
    }

    .oee-operator-pulse {
      animation: oeePulse 0.6s ease;
    }

    @keyframes oeePulse {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { box-shadow: 0 0 0 18px rgba(16, 185, 129, 0); }
      100% { box-shadow: none; }
    }

    .oee-operator-dropdown {
      position: absolute;
      right: 1.5rem;
      top: 100%;
      margin-top: 0.5rem;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.5rem;
      min-width: 180px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .oee-operator-dropdown button {
      background: transparent;
      border: none;
      color: var(--text);
      text-align: left;
      padding: 0.6rem 0.75rem;
      border-radius: 0.6rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .oee-operator-dropdown button:hover {
      background: rgba(99, 102, 241, 0.2);
    }

    .oee-operator-history {
      margin-top: 1rem;
      border-radius: 0.85rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.55);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .oee-operator-history strong {
      font-size: 0.95rem;
    }

    .oee-operator-recap {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      padding: 1.75rem;
      position: sticky;
      top: 6.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
    }

    .oee-operator-recap-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .oee-operator-recap-grid {
      display: grid;
      gap: 1rem;
    }

    .oee-operator-recap-item {
      background: rgba(148, 163, 184, 0.1);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .oee-operator-recap-item span {
      color: var(--text-muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .oee-operator-recap-item strong {
      font-size: 1.3rem;
    }

    .oee-operator-recap-causes h4 {
      font-size: 0.95rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Chart section */
    .chart-section {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 1px solid var(--border);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    canvas {
      max-height: 350px;
    }

    /* Modal moderne */
    dialog {
      background: var(--card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 600px;
      width: 90vw;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--card-light);
      border: 2px solid var(--border);
      border-radius: 0.75rem;
      color: var(--text);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--glow);
    }

    .justify-display {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(192, 132, 252, 0.2) 100%);
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      margin: 1.5rem 0;
      border: 2px solid var(--primary);
    }

    .justify-value {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .quick-causes {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .cause-chip {
      padding: 0.5rem 1rem;
      background: var(--card-light);
      border: 2px solid var(--border);
      border-radius: 0.75rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .cause-chip:hover {
      background: var(--primary);
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      justify-content: flex-end;
    }

    /* Confetti celebration */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--success);
      position: absolute;
      animation: confetti-fall 3s linear forwards;
    }

    @keyframes confetti-fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    .toast.info {
      border-left: 4px solid var(--primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .kpi-section {
        grid-template-columns: 1fr;
      }
      
      .badges-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Section titles */
    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 2rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
      border-radius: 2px;
    }

    [data-view] {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .settings-section {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      border: 1px solid var(--border);
      padding: 2rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .settings-card {
      background: var(--card-light);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .settings-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
    }

    .settings-description {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .table-wrapper {
      max-height: 320px;
      overflow-y: auto;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }

    .settings-table {
      width: 100%;
      border-collapse: collapse;
    }

    .settings-table th,
    .settings-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--text-muted);
      text-align: left;
    }

    .settings-table tr:last-child td {
      border-bottom: none;
    }

    .settings-table td input {
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-weight: 600;
    }

    .settings-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .threshold-fields {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .threshold-fields label {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .threshold-fields input {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>üè≠ Dashboard Production Atelier</h1>
      <div class="header-actions">
        <div class="controls">
          <button class="btn btn-secondary" id="export-btn">üìä Exporter</button>
          <button class="btn btn-primary" id="refresh-btn">üîÑ Actualiser</button>
        </div>
        <div class="view-tabs">
          <button class="btn btn-secondary" data-nav="operateur">Op√©rateur</button>
          <button class="btn btn-secondary" data-nav="analyse">Analyse</button>
          <button class="btn btn-secondary" data-nav="parametres">Param√®tres</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div data-view="operateur">
      <section class="oee-operator-wrapper">
        <div class="oee-operator-column">
          <header class="oee-operator-column-header">
            <div class="oee-operator-column-header-left">
              <span class="oee-operator-team-label">√âquipe active</span>
              <div class="oee-operator-team-selector" id="oee-operator-team-selector">
                <select id="oee-operator-team-select" class="oee-operator-team-select" aria-label="S√©lectionner l'√©quipe active"></select>
              </div>
            </div>
            <div class="oee-operator-team-oee">
              <span>OEE √©quipe</span>
              <strong id="oee-operator-team-oee">‚Äî%</strong>
            </div>
          </header>
          <div class="oee-operator-hours" id="oee-operator-hours"></div>
        </div>
        <aside class="oee-operator-recap" id="oee-operator-recap">
          <h3 class="oee-operator-recap-title">R√©cap journ√©e</h3>
          <div class="oee-operator-recap-grid">
            <div class="oee-operator-recap-item">
              <span>OEE moyen</span>
              <strong id="oee-recap-oee">‚Äî%</strong>
            </div>
            <div class="oee-operator-recap-item">
              <span>Disponibilit√© moyenne</span>
              <strong id="oee-recap-availability">‚Äî%</strong>
            </div>
            <div class="oee-operator-recap-item">
              <span>Temps d'arr√™ts cumul√©</span>
              <strong id="oee-recap-downtime">0 min</strong>
            </div>
            <div class="oee-operator-recap-item">
              <span>Nombre d'√©v√©nements</span>
              <strong id="oee-recap-events">0</strong>
            </div>
          </div>
          <div class="oee-operator-recap-causes">
            <h4>Top 3 causes</h4>
            <ol id="oee-recap-top-causes" class="oee-operator-recap-list"></ol>
          </div>
        </aside>
      </section>
    </div>

    <div data-view="analyse">
      <!-- KPI Cards -->
      <section class="kpi-section">
      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">TRS Global</span>
          <span class="kpi-icon">‚ö°</span>
        </div>
        <div class="kpi-value" id="kpi-trs">0%</div>
        <div class="kpi-trend" id="trs-trend">
          <span>‚Üó</span> +2.3% vs hier
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Disponibilit√©</span>
          <span class="kpi-icon">üéØ</span>
        </div>
        <div class="kpi-value" id="kpi-availability">0%</div>
        <div class="kpi-trend">
          <span>‚Üí</span> Stable
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Performance</span>
          <span class="kpi-icon">üöÄ</span>
        </div>
        <div class="kpi-value" id="kpi-performance">0%</div>
        <div class="kpi-trend">
          <span>‚Üó</span> +1.5% vs hier
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Production Journ√©e</span>
          <span class="kpi-icon">üì¶</span>
        </div>
        <div class="kpi-value" id="kpi-total">0</div>
        <div class="kpi-trend" id="target-trend">
          <span>‚Üí</span> Objectif: 384k
        </div>
      </div>
    </section>

    <!-- Badges Section -->
    <section class="badges-section">
      <h2 class="section-title">üèÜ Achievements</h2>
      <div class="badges-grid" id="badges-grid">
        <div class="badge" data-badge="perfect-hour">
          <div class="badge-icon">üåü</div>
          <div class="badge-label">Heure Parfaite</div>
        </div>
        <div class="badge" data-badge="zero-downtime">
          <div class="badge-icon">‚ö°</div>
          <div class="badge-label">Z√©ro Arr√™t</div>
        </div>
        <div class="badge" data-badge="streak-3">
          <div class="badge-icon">üî•</div>
          <div class="badge-label">Streak x3</div>
        </div>
        <div class="badge" data-badge="team-champion">
          <div class="badge-icon">üëë</div>
          <div class="badge-label">Champion √âquipe</div>
        </div>
        <div class="badge" data-badge="consistency">
          <div class="badge-icon">üíé</div>
          <div class="badge-label">R√©gularit√©</div>
        </div>
      </div>
    </section>
    <!-- Chart Section -->
    <section class="chart-section">
      <div class="chart-header">
        <h2 class="chart-title">üìà Performance en Temps R√©el</h2>
      </div>
      <canvas id="production-chart"></canvas>
    </section>
    </div>

    <div data-view="parametres">
      <section class="settings-section">
        <h2 class="section-title">‚öôÔ∏è Param√®tres</h2>
        <div class="settings-grid">
          <div class="settings-card">
            <div class="settings-title">Cadence cible</div>
            <div class="settings-description">D√©finissez la cadence horaire nominale utilis√©e pour calculer les TRS et les justifications.</div>
            <div>
              <label style="color: var(--text-muted); font-size: 0.9rem; font-weight: 600; display: flex; flex-direction: column; gap: 0.5rem;">
                Cadence (u/h)
                <input type="number" id="target-rate" value="16000" style="width: 100%; background: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 0.5rem 0.75rem; color: var(--text);" />
              </label>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Affectation des √©quipes</div>
            <div class="settings-description">Ajustez l'√©quipe responsable de chaque tranche horaire pour un suivi pr√©cis.</div>
            <div class="table-wrapper">
              <table class="settings-table">
                <thead>
                  <tr>
                    <th>Heure</th>
                    <th>√âquipe</th>
                  </tr>
                </thead>
                <tbody id="team-assignments-body"></tbody>
              </table>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Cat√©gories &amp; Sous-cat√©gories</div>
            <div class="settings-description">D√©finissez les cat√©gories et sous-cat√©gories d‚Äô√©v√©nements (ex : Machine &gt; D√©pileuse). Ces √©l√©ments seront utilis√©s dans les causes d‚Äôarr√™t.</div>
            <div class="table-wrapper">
              <table class="settings-table">
                <thead>
                  <tr>
                    <th>Cat√©gorie</th>
                    <th>Sous-cat√©gorie</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="categories-table-body"></tbody>
              </table>
            </div>
            <div class="settings-actions">
              <button class="btn btn-secondary" id="add-category-row-btn">‚ûï Ajouter une ligne</button>
              <button class="btn btn-primary" id="save-categories-btn">üíæ Sauvegarder</button>
              <button class="btn btn-secondary" id="export-categories-btn">üì§ Exporter</button>
              <button class="btn btn-secondary" id="import-categories-btn">üì• Importer</button>
              <input type="file" id="categories-import-input" accept="application/json" style="display: none;" />
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Seuils TRS</div>
            <div class="settings-description">Personnalisez les seuils de performance utilis√©s pour colorer les cartes horaires.</div>
            <div class="threshold-fields">
              <label>
                Excellent (‚â• %)
                <input type="number" id="threshold-excellent" min="0" max="100" value="95" />
              </label>
              <label>
                Bon (‚â• %)
                <input type="number" id="threshold-good" min="0" max="100" value="85" />
              </label>
              <label>
                Faible (&lt; %)
                <input type="number" id="threshold-low" min="0" max="100" value="85" disabled style="opacity: 0.6; cursor: not-allowed;" />
              </label>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Gestion</div>
            <div class="settings-description">Sauvegardez vos r√©glages ou r√©initialisez la journ√©e en cours.</div>
            <div class="settings-actions">
              <button class="btn btn-primary" id="save-settings-btn">üíæ Sauvegarder param√®tres</button>
              <button class="btn btn-secondary" id="import-config-btn">üì• Importer config</button>
              <button class="btn btn-secondary" id="export-config-btn">üì§ Exporter config</button>
              <button class="btn btn-secondary" id="reset-day-btn">üßπ R√©initialiser journ√©e</button>
              <input type="file" id="config-import-input" accept="application/json" style="display: none;" />
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const DEFAULT_VIEW = 'operateur';
    const DEFAULT_TEAM_ASSIGNMENTS = [
      'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit',
      'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour',
      'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir'
    ];

    let TEAM_ASSIGNMENTS = [...DEFAULT_TEAM_ASSIGNMENTS];
    let TRS_THRESHOLDS = { excellent: 95, good: 85 };
    let CATEGORY_DATA = [
      { category: 'Machine', subcategory: 'D√©pileuse' },
      { category: 'Machine', subcategory: 'MASS' }
    ];

    // √âtat global en m√©moire (PAS de localStorage)
    function createEmptyHourlyData() {
      return new Array(24).fill(null).map((_, i) => ({
        hour: i,
        good: 0,
        causes: [],
        comment: '',
        validated: false,
        edits: []
      }));
    }

    let hourlyData = createEmptyHourlyData();

    let activeTeam = '';
    let openTileHour = null;
    const editingStates = {};
    let recentSubcategories = [];
    let visibleDropdownHour = null;
    let visibleHistoryHour = null;
    let quickEditHour = null;
    const DEBOUNCE_DELAY = 150;

    const VERSION_STATE = { major: 0, minor: 0, patch: 0 };
    const VERSION_NOTES = [];

    let currentChart = null;
    let unlockedBadges = new Set();

    function bump(level = 'patch', notes = []) {
      const normalizedNotes = Array.isArray(notes) ? notes : [notes];

      switch (level) {
        case 'major':
          VERSION_STATE.major += 1;
          VERSION_STATE.minor = 0;
          VERSION_STATE.patch = 0;
          break;
        case 'minor':
          VERSION_STATE.minor += 1;
          VERSION_STATE.patch = 0;
          break;
        default:
          VERSION_STATE.patch += 1;
          break;
      }

      normalizedNotes
        .filter(note => typeof note === 'string' && note.trim().length > 0)
        .forEach(note => {
          VERSION_NOTES.push({
            timestamp: new Date().toISOString(),
            note: note.trim()
          });
        });

      return getVersion();
    }

    function getVersion() {
      return `${VERSION_STATE.major}.${VERSION_STATE.minor}.${VERSION_STATE.patch}`;
    }

    bump('minor', ['Page Op√©rateur: vue monocolonne √©quipe active, rebut supprim√©, causes accord√©on, r√©cap journ√©e']);

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      populateParameters();
      initOperatorView();
      updateKPIs();
      initChart();
      highlightCurrentHour();
      checkBadges();
      setupNavigation();

      setInterval(highlightCurrentHour, 60000);

      showView(location.hash.replace('#', '') || DEFAULT_VIEW);
    });

    window.addEventListener('hashchange', () => {
      const view = location.hash.replace('#', '') || DEFAULT_VIEW;
      showView(view);
    });

    function showView(view) {
      document.querySelectorAll('[data-view]').forEach(v => {
        v.style.display = 'none';
      });

      const normalized = ['operateur', 'analyse', 'parametres'].includes(view) ? view : DEFAULT_VIEW;
      const element = document.querySelector(`[data-view="${normalized}"]`) || document.querySelector('[data-view="operateur"]');
      if (element) {
        element.style.display = '';
      }

      setActiveTab(normalized);

      if (normalized === 'operateur') {
        renderOperatorView();
        highlightCurrentHour();
      }

      if (normalized === 'analyse') {
        refreshDisplay();
        updateChart();
      }

      if (normalized === 'parametres') {
        populateParameters();
      }
    }

    function setActiveTab(view) {
      document.querySelectorAll('[data-nav]').forEach(btn => btn.classList.remove('btn-active'));
      const activeBtn = document.querySelector(`[data-nav="${view}"]`);
      if (activeBtn) {
        activeBtn.classList.add('btn-active');
      }
    }

    function setupNavigation() {
      document.querySelectorAll('[data-nav]').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetView = btn.dataset.nav;
          if (targetView) {
            location.hash = `#${targetView}`;
          }
        });
      });
    }

    function initOperatorView() {
      const select = document.getElementById('oee-operator-team-select');
      activeTeam = determineInitialActiveTeam();
      renderOperatorTeamSelector();
      renderOperatorTiles();
      updateOperatorRecap();

      if (select && !select.dataset.initialized) {
        select.addEventListener('change', () => {
          setActiveTeam(select.value);
        });
        select.dataset.initialized = 'true';
      }
    }

    function renderOperatorView() {
      renderOperatorTeamSelector();
      renderOperatorTiles();
      updateOperatorRecap();
    }

    function updateOperatorRecap() {
      const oeeEl = document.getElementById('oee-recap-oee');
      const availabilityEl = document.getElementById('oee-recap-availability');
      const downtimeEl = document.getElementById('oee-recap-downtime');
      const eventsEl = document.getElementById('oee-recap-events');
      const listEl = document.getElementById('oee-recap-top-causes');
      const teamOeeEl = document.getElementById('oee-operator-team-oee');

      if (!oeeEl || !availabilityEl || !downtimeEl || !eventsEl || !listEl || !teamOeeEl) {
        return;
      }

      const teamHours = hourlyData.filter((data, index) => {
        const teamName = TEAM_ASSIGNMENTS[index] || '';
        return data.validated && teamName.trim() === (activeTeam || '').trim();
      });

      if (teamHours.length === 0) {
        oeeEl.textContent = '‚Äî%';
        availabilityEl.textContent = '‚Äî%';
        downtimeEl.textContent = '0 min';
        eventsEl.textContent = '0';
        listEl.innerHTML = '';
        teamOeeEl.textContent = '‚Äî%';
        return;
      }

      let sumAvailability = 0;
      let sumPerformance = 0;
      let sumOee = 0;
      let totalDowntime = 0;
      let eventCount = 0;
      const causeMap = new Map();

      teamHours.forEach(data => {
        const metrics = calculateTileMetrics(data);
        sumAvailability += metrics.availability;
        sumPerformance += metrics.performance;
        sumOee += metrics.oee;
        totalDowntime += metrics.downtime;

        const validCauses = (data.causes || []).filter(cause => (cause.minutes || 0) > 0);
        eventCount += validCauses.length;

        validCauses.forEach(cause => {
          const key = getCauseKey(cause.category, cause.subcategory);
          const existing = causeMap.get(key) || { category: cause.category, subcategory: cause.subcategory, minutes: 0 };
          existing.minutes += cause.minutes || 0;
          causeMap.set(key, existing);
        });
      });

      const count = teamHours.length;
      const avgAvailability = sumAvailability / count;
      const avgPerformance = sumPerformance / count;
      const avgOee = sumOee / count;

      oeeEl.textContent = `${Math.round(avgOee)}%`;
      teamOeeEl.textContent = `${Math.round(avgOee)}%`;
      availabilityEl.textContent = `${Math.round(avgAvailability * 100)}%`;
      downtimeEl.textContent = formatMinutes(totalDowntime);
      eventsEl.textContent = String(eventCount);

      const causes = Array.from(causeMap.values())
        .filter(cause => cause.minutes > 0)
        .sort((a, b) => b.minutes - a.minutes)
        .slice(0, 3);

      listEl.innerHTML = '';
      if (causes.length === 0) {
        const empty = document.createElement('li');
        empty.textContent = 'Aucune cause majeure.';
        listEl.appendChild(empty);
      } else {
        causes.forEach(cause => {
          const item = document.createElement('li');
          const label = cause.subcategory ? `${cause.category} ‚Ä¢ ${cause.subcategory}` : cause.category;
          const percentage = totalDowntime > 0 ? Math.round((cause.minutes / totalDowntime) * 100) : 0;
          const text = document.createElement('span');
          text.textContent = label;
          const value = document.createElement('strong');
          value.textContent = `${percentage}%`; 
          item.appendChild(text);
          item.appendChild(value);
          listEl.appendChild(item);
        });
      }
    }

    function renderOperatorTeamSelector() {
      const select = document.getElementById('oee-operator-team-select');
      if (!select) return;

      const teams = getUniqueTeams();
      if (!teams.length) {
        teams.push('√âquipe');
      }

      if (!teams.includes(activeTeam)) {
        activeTeam = teams[0];
      }

      select.innerHTML = '';
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team;
        option.textContent = team;
        select.appendChild(option);
      });
      select.value = activeTeam;
    }

    function getUniqueTeams() {
      const teams = TEAM_ASSIGNMENTS
        .map(team => typeof team === 'string' ? team.trim() : '')
        .filter(team => team.length > 0);
      return [...new Set(teams)];
    }

    function determineInitialActiveTeam() {
      const currentHour = new Date().getHours();
      const currentTeam = TEAM_ASSIGNMENTS[currentHour];
      if (currentTeam && currentTeam.trim()) {
        return currentTeam.trim();
      }

      const teams = getUniqueTeams();
      if (teams.length) {
        return teams[0];
      }

      return '√âquipe';
    }

    function setActiveTeam(team) {
      if (!team || team === activeTeam) {
        renderOperatorView();
        return;
      }

      activeTeam = team;
      renderOperatorView();
    }

    function renderOperatorTiles() {
      const container = document.getElementById('oee-operator-hours');
      if (!container) return;

      const previousScroll = container.scrollTop;
      hourlyData = hourlyData.map((data, index) => normalizeTileData(data, index));

      container.innerHTML = '';
      const currentHour = new Date().getHours();

      hourlyData.forEach((data, hour) => {
        const tile = createTileElement(data, hour === currentHour);
        container.appendChild(tile);
      });

      container.scrollTop = previousScroll;
    }

    function highlightCurrentHour() {
      const currentHour = new Date().getHours();
      document.querySelectorAll('.oee-operator-tile').forEach(tile => {
        const hour = parseInt(tile.dataset.hour, 10);
        if (hour === currentHour) {
          tile.classList.add('oee-operator-active');
        } else {
          tile.classList.remove('oee-operator-active');
        }
      });
    }

    function normalizeTileData(data, hour) {
      const safe = data || {};
      const normalizedCauses = Array.isArray(safe.causes)
        ? safe.causes.map(normalizeCause).filter(Boolean)
        : [];

      return {
        hour,
        good: Number.isFinite(safe.good) ? Math.max(0, Math.round(safe.good)) : 0,
        causes: capCausesToSixty(normalizedCauses),
        comment: typeof safe.comment === 'string' ? safe.comment : '',
        validated: Boolean(safe.validated),
        edits: Array.isArray(safe.edits) ? [...safe.edits] : []
      };
    }

    function normalizeCause(cause) {
      if (!cause) return null;
      const minutes = clampMinutes(cause.minutes);

      if (typeof cause.category === 'string' || typeof cause.subcategory === 'string') {
        const category = (cause.category || '').trim() || 'Divers';
        const subcategory = (cause.subcategory || '').trim();
        return { category, subcategory, minutes };
      }

      if (typeof cause.name === 'string') {
        const name = cause.name.trim();
        return { category: 'Divers', subcategory: name, minutes };
      }

      return null;
    }

    function capCausesToSixty(causes) {
      let total = 0;
      return causes.map(cause => {
        const available = Math.max(0, 60 - total);
        const minutes = Math.min(available, cause.minutes);
        total += minutes;
        return { ...cause, minutes };
      });
    }

    function clampMinutes(value) {
      const minutes = Math.round(Number(value) || 0);
      return Math.max(0, Math.min(60, minutes));
    }

    function calculateTileMetrics(source) {
      const targetRate = getTargetRate();
      const good = Math.max(0, Math.round(Number(source.good) || 0));
      const downtime = Math.min(60, Math.max(0, (source.causes || []).reduce((sum, cause) => sum + (cause.minutes || 0), 0)));
      const availability = Math.max(0, (60 - downtime) / 60);
      const performance = targetRate > 0 ? Math.min(1, good / targetRate) : 0;
      const quality = 1;
      const rawOee = availability * performance * quality * 100;
      const oee = Math.min(100, Math.round(rawOee));

      return { availability, performance, quality, oee, rawOee, downtime, good, targetRate };
    }

    function getTargetRate() {
      const input = document.getElementById('target-rate');
      const value = input ? parseInt(input.value, 10) : 16000;
      return Number.isFinite(value) && value > 0 ? value : 16000;
    }

    function formatPercent(value) {
      if (!Number.isFinite(value)) {
        return '‚Äî%';
      }
      return `${Math.round(value * 100)}%`;
    }

    function formatMinutes(value) {
      const minutes = Math.round(Math.max(0, Number(value) || 0));
      return `${minutes} min`;
    }

    function formatUnits(value) {
      const number = Math.max(0, Math.round(Number(value) || 0));
      return number.toLocaleString('fr-FR');
    }

    function ensureEditingState(hour) {
      if (!editingStates[hour]) {
        editingStates[hour] = createEditingStateFromData(hourlyData[hour]);
      }
      return editingStates[hour];
    }

    function createEditingStateFromData(data) {
      const normalized = normalizeTileData(data, data.hour);
      return {
        hour: normalized.hour,
        good: normalized.good,
        causes: normalized.causes.map(cause => ({ ...cause })),
        comment: normalized.comment,
        openCategories: {},
        validated: normalized.validated
      };
    }

    function openTile(hour, { prefillGood } = {}) {
      openTileHour = hour;
      const state = ensureEditingState(hour);
      if (prefillGood) {
        state.good = Math.max(state.good, getTargetRate());
        const categories = Array.from(getCategoryGroups().keys());
        if (categories.length) {
          state.openCategories = state.openCategories || {};
          state.openCategories[categories[0]] = true;
        }
      }
      renderOperatorView();
      focusFirstInput(hour);
    }

    function focusFirstInput(hour) {
      requestAnimationFrame(() => {
        const tile = document.querySelector(`.oee-operator-tile[data-hour="${hour}"]`);
        if (!tile) return;
        const input = tile.querySelector('input[type="number"].oee-operator-production-input');
        if (input) {
          input.focus({ preventScroll: true });
        }
      });
    }

    function closeTile(hour, { resetState = true } = {}) {
      if (resetState) {
        delete editingStates[hour];
      }
      if (openTileHour === hour) {
        openTileHour = null;
      }
      quickEditHour = null;
      visibleDropdownHour = null;
      visibleHistoryHour = null;
      renderOperatorView();
    }

    function createTileElement(data, isCurrentHour) {
      const tile = document.createElement('article');
      tile.className = 'oee-operator-tile';
      tile.dataset.hour = data.hour;

      if (isCurrentHour) {
        tile.classList.add('oee-operator-active');
      }

      const isOpen = openTileHour === data.hour;
      const source = isOpen ? ensureEditingState(data.hour) : data;
      const metrics = calculateTileMetrics(source);
      const hasMetrics = isOpen || data.validated;

      if (data.validated) {
        tile.classList.add(getTileStatusClass(metrics.oee));
      }

      if (isOpen) {
        tile.classList.add('oee-operator-open');
      }

      const header = buildTileHeader(tile, data, metrics, hasMetrics, isOpen);
      tile.appendChild(header);

      if (visibleHistoryHour === data.hour) {
        const historyPanel = buildHistoryPanel(data);
        tile.appendChild(historyPanel);
      }

      const body = isOpen ? buildTileBody(data, metrics) : null;
      if (body) {
        tile.appendChild(body);
      }

      return tile;
    }

    function getTileStatusClass(oee) {
      if (oee >= TRS_THRESHOLDS.excellent) {
        return 'oee-operator-valid-high';
      }
      if (oee >= TRS_THRESHOLDS.good) {
        return 'oee-operator-valid-medium';
      }
      return 'oee-operator-valid-low';
    }

    function buildTileHeader(tile, data, metrics, hasMetrics, isOpen) {
      const header = document.createElement('button');
      header.type = 'button';
      header.className = 'oee-operator-tile-header';
      header.setAttribute('aria-expanded', String(isOpen));

      header.addEventListener('click', (event) => {
        if (event.detail === 0) return; // keyboard toggle handled separately
        if (openTileHour === data.hour) {
          closeTile(data.hour);
        } else {
          openTile(data.hour);
        }
      });

      header.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          if (openTileHour === data.hour) {
            closeTile(data.hour);
          } else {
            openTile(data.hour);
          }
        }
      });

      header.addEventListener('dblclick', (event) => {
        event.preventDefault();
        event.stopPropagation();
        if (!data.validated) {
          openTile(data.hour, { prefillGood: true });
        }
      });

      const info = document.createElement('div');
      info.className = 'oee-operator-tile-info';

      const time = document.createElement('div');
      time.className = 'oee-operator-time';
      time.textContent = `${String(data.hour).padStart(2, '0')}:00`;

      const teamName = document.createElement('div');
      teamName.className = 'oee-operator-team-name';
      teamName.textContent = TEAM_ASSIGNMENTS[data.hour] || '';

      info.appendChild(time);
      info.appendChild(teamName);

      const summary = document.createElement('div');
      summary.className = 'oee-operator-summary';

      if (data.validated) {
        renderValidatedSummary(summary, data, metrics);
      } else {
        const empty = document.createElement('div');
        empty.className = 'oee-operator-empty-label';
        empty.textContent = 'Cliquez pour saisir';
        summary.appendChild(empty);
      }

      if (quickEditHour === data.hour && data.validated) {
        summary.appendChild(buildQuickEditForm(data.hour, data.good));
      }

      const metricsBlock = document.createElement('div');
      metricsBlock.className = 'oee-operator-metrics';

      const metricValue = document.createElement('div');
      metricValue.className = 'oee-operator-metric-value';
      metricValue.textContent = hasMetrics ? `${Math.min(100, Math.round(metrics.oee))}%` : '‚Äî%';

      const breakdown = document.createElement('div');
      breakdown.className = 'oee-operator-metric-breakdown';
      const availabilitySpan = document.createElement('span');
      availabilitySpan.textContent = `D ${hasMetrics ? formatPercent(metrics.availability) : '‚Äî%'}`;
      const performanceSpan = document.createElement('span');
      performanceSpan.textContent = `P ${hasMetrics ? formatPercent(metrics.performance) : '‚Äî%'}`;
      const qualitySpan = document.createElement('span');
      qualitySpan.textContent = 'Q 100%';

      breakdown.appendChild(availabilitySpan);
      breakdown.appendChild(performanceSpan);
      breakdown.appendChild(qualitySpan);

      metricsBlock.appendChild(metricValue);
      metricsBlock.appendChild(breakdown);

      header.appendChild(info);
      header.appendChild(summary);
      header.appendChild(metricsBlock);

      return header;
    }

    function renderValidatedSummary(container, data, metrics) {
      const badges = document.createElement('div');
      badges.className = 'oee-operator-badges';

      const goodBadge = document.createElement('button');
      goodBadge.type = 'button';
      goodBadge.className = 'oee-operator-badge oee-operator-badge-action';
      goodBadge.title = 'Modifier la production bonne';
      const goodLabel = document.createElement('span');
      goodLabel.textContent = 'Bonne';
      const goodValue = document.createElement('strong');
      goodValue.textContent = `${formatUnits(data.good)} u`;
      goodBadge.appendChild(goodLabel);
      goodBadge.appendChild(goodValue);
      goodBadge.addEventListener('click', (event) => {
        event.stopPropagation();
        showQuickEdit(data.hour);
      });

      const stopBadge = document.createElement('span');
      stopBadge.className = 'oee-operator-badge';
      const stopLabel = document.createElement('span');
      stopLabel.textContent = 'Arr√™ts';
      const stopValue = document.createElement('strong');
      stopValue.textContent = formatMinutes(metrics.downtime);
      stopBadge.appendChild(stopLabel);
      stopBadge.appendChild(stopValue);

      badges.appendChild(goodBadge);
      badges.appendChild(stopBadge);
      container.appendChild(badges);

      const causesSummary = document.createElement('div');
      causesSummary.className = 'oee-operator-causes-summary';
      if (data.causes.length === 0) {
        const noCause = document.createElement('span');
        noCause.textContent = 'Aucune cause saisie';
        causesSummary.appendChild(noCause);
      } else {
        data.causes.forEach(cause => {
          const item = document.createElement('span');
          const label = cause.subcategory ? `${cause.category} ‚Ä¢ ${cause.subcategory}` : cause.category;
          item.textContent = `${label} (${formatMinutes(cause.minutes)})`;
          causesSummary.appendChild(item);
        });
      }
      container.appendChild(causesSummary);

      const actions = document.createElement('div');
      actions.className = 'oee-operator-actions-inline';

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'oee-operator-icon-button';
      editBtn.title = 'Modifier la tuile';
      editBtn.textContent = '‚úèÔ∏è';
      editBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        openTile(data.hour);
      });

      const menuBtn = document.createElement('button');
      menuBtn.type = 'button';
      menuBtn.className = 'oee-operator-icon-button';
      menuBtn.title = 'Actions';
      menuBtn.textContent = '‚ãØ';
      menuBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleTileMenu(data.hour, container, menuBtn);
      });

      actions.appendChild(editBtn);
      actions.appendChild(menuBtn);
      container.appendChild(actions);

      if (visibleDropdownHour === data.hour) {
        container.appendChild(buildTileDropdown(data.hour));
      }
    }

    function showQuickEdit(hour) {
      quickEditHour = hour;
      renderOperatorView();
      requestAnimationFrame(() => {
        const input = document.querySelector(`.oee-operator-quick-edit[data-hour="${hour}"] input`);
        if (input) {
          input.focus();
          input.select();
        }
      });
    }

    function buildQuickEditForm(hour, currentValue) {
      const form = document.createElement('form');
      form.className = 'oee-operator-quick-edit';
      form.dataset.hour = hour;

      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '100';
      input.value = Math.round(currentValue || 0);
      input.setAttribute('aria-label', 'Production bonne (unit√©s)');

      const saveBtn = document.createElement('button');
      saveBtn.type = 'submit';
      saveBtn.textContent = 'OK';

      const cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.textContent = 'Annuler';
      cancelBtn.addEventListener('click', (event) => {
        event.preventDefault();
        quickEditHour = null;
        renderOperatorView();
      });

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const newValue = Math.max(0, Math.round(Number(input.value) || 0));
        applyQuickEdit(hour, newValue);
      });

      form.appendChild(input);
      form.appendChild(saveBtn);
      form.appendChild(cancelBtn);

      return form;
    }

    function applyQuickEdit(hour, newValue) {
      const data = hourlyData[hour];
      if (!data) return;
      const previous = data.good;
      if (previous === newValue) {
        quickEditHour = null;
        renderOperatorView();
        return;
      }

      data.good = newValue;
      data.validated = true;
      recordEdit(hour, { good: { from: previous, to: newValue } });
      quickEditHour = null;
      renderOperatorView();
      updateKPIs();
      updateOperatorRecap();
      updateChart();
      checkBadges();
      showToast('Production mise √† jour', 'success');
    }

    function toggleTileMenu(hour, container, anchor) {
      if (visibleDropdownHour === hour) {
        visibleDropdownHour = null;
        renderOperatorView();
        return;
      }

      visibleDropdownHour = hour;
      renderOperatorView();
      requestAnimationFrame(() => {
        const tile = document.querySelector(`.oee-operator-tile[data-hour="${hour}"]`);
        if (!tile) return;
        const dropdown = tile.querySelector('.oee-operator-dropdown');
        if (!dropdown) return;
        dropdown.focus();
      });
    }

    function buildHistoryPanel(data) {
      const history = document.createElement('div');
      history.className = 'oee-operator-history';

      const title = document.createElement('strong');
      title.textContent = 'Historique des modifications';
      history.appendChild(title);

      if (!Array.isArray(data.edits) || data.edits.length === 0) {
        const empty = document.createElement('span');
        empty.textContent = 'Aucune modification enregistr√©e.';
        history.appendChild(empty);
        return history;
      }

      data.edits.slice().reverse().forEach(entry => {
        const item = document.createElement('div');
        const time = new Date(entry.timestampISO || entry.timestamp || Date.now());
        const timeLabel = time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        let description = 'Modifi√©';
        if (entry.fieldChanges) {
          const fields = Object.keys(entry.fieldChanges).map(field => field.toUpperCase()).join(', ');
          if (fields) {
            description = `Champs: ${fields}`;
          }
        }
        item.textContent = `${description} √† ${timeLabel}`;
        history.appendChild(item);
      });

      return history;
    }

    function buildTileDropdown(hour) {
      const dropdown = document.createElement('div');
      dropdown.className = 'oee-operator-dropdown';
      dropdown.tabIndex = -1;

      const historyBtn = document.createElement('button');
      historyBtn.type = 'button';
      historyBtn.textContent = 'Historique';
      historyBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        visibleHistoryHour = visibleHistoryHour === hour ? null : hour;
        visibleDropdownHour = null;
        renderOperatorView();
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Supprimer l\'heure';
      deleteBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        visibleDropdownHour = null;
        const label = `${String(hour).padStart(2, '0')}:00`;
        if (confirm(`Supprimer la saisie de ${label} ?`)) {
          deleteHour(hour);
        } else {
          renderOperatorView();
        }
      });

      dropdown.appendChild(historyBtn);
      dropdown.appendChild(deleteBtn);
      return dropdown;
    }

    function deleteHour(hour) {
      const empty = createEmptyHourlyData()[hour];
      hourlyData[hour] = { ...empty };
      delete editingStates[hour];
      if (openTileHour === hour) {
        openTileHour = null;
      }
      quickEditHour = null;
      visibleHistoryHour = null;
      renderOperatorView();
      updateKPIs();
      updateOperatorRecap();
      updateChart();
      checkBadges();
      showToast('Heure supprim√©e', 'info');
    }

    function recordEdit(hour, fieldChanges) {
      const data = hourlyData[hour];
      if (!data) return;
      if (!Array.isArray(data.edits)) {
        data.edits = [];
      }
      data.edits.push({
        timestampISO: new Date().toISOString(),
        fieldChanges
      });
    }

    function buildTileBody(data, metrics) {
      const state = ensureEditingState(data.hour);
      const body = document.createElement('div');
      body.className = 'oee-operator-tile-body';

      const productionRow = document.createElement('div');
      productionRow.className = 'oee-operator-input-row';

      const numberField = document.createElement('div');
      numberField.className = 'oee-operator-number-field';

      const minusBtn = document.createElement('button');
      minusBtn.type = 'button';
      minusBtn.className = 'oee-operator-step';
      minusBtn.textContent = '‚àí';
      minusBtn.addEventListener('click', (event) => {
        event.preventDefault();
        adjustProduction(data.hour, -100);
      });

      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '100';
      input.value = Math.max(0, state.good);
      input.classList.add('oee-operator-production-input');
      input.setAttribute('aria-label', 'Production bonne (unit√©s)');
      input.addEventListener('input', debounce(() => {
        const value = Math.max(0, Math.round(Number(input.value) || 0));
        state.good = value;
        editingStates[data.hour] = state;
        renderOperatorView();
      }, DEBOUNCE_DELAY));

      const plusBtn = document.createElement('button');
      plusBtn.type = 'button';
      plusBtn.className = 'oee-operator-step';
      plusBtn.textContent = '+';
      plusBtn.addEventListener('click', (event) => {
        event.preventDefault();
        adjustProduction(data.hour, 100);
      });

      numberField.appendChild(minusBtn);
      numberField.appendChild(input);
      numberField.appendChild(plusBtn);

      productionRow.appendChild(numberField);
      body.appendChild(productionRow);

      const stateMetrics = calculateTileMetrics(state);
      const minutesSection = document.createElement('div');
      minutesSection.className = 'oee-operator-minutes';

      const minutesHeader = document.createElement('div');
      minutesHeader.className = 'oee-operator-minutes-header';
      const minutesLabel = document.createElement('span');
      minutesLabel.textContent = 'Minutes √† justifier';
      const minutesValue = document.createElement('strong');
      minutesValue.textContent = `${formatMinutes(stateMetrics.downtime)} / 60`;
      minutesHeader.appendChild(minutesLabel);
      minutesHeader.appendChild(minutesValue);

      const minutesBar = document.createElement('div');
      minutesBar.className = 'oee-operator-minutes-bar';
      const progress = document.createElement('div');
      progress.className = 'oee-operator-minutes-progress';
      progress.style.width = `${Math.min(100, (stateMetrics.downtime / 60) * 100)}%`;
      progress.classList.add(getMinutesColorClass(stateMetrics.downtime));
      minutesBar.appendChild(progress);

      minutesSection.appendChild(minutesHeader);
      minutesSection.appendChild(minutesBar);
      body.appendChild(minutesSection);

      if (recentSubcategories.length) {
        const recentWrapper = document.createElement('div');
        recentWrapper.className = 'oee-operator-recent';
        const title = document.createElement('div');
        title.className = 'oee-operator-recent-title';
        title.textContent = 'Derni√®res utilis√©es';
        const grid = document.createElement('div');
        grid.className = 'oee-operator-recent-grid';
        recentSubcategories.forEach(({ category, subcategory }) => {
          grid.appendChild(buildCauseCard(data.hour, state, category, subcategory));
        });
        recentWrapper.appendChild(title);
        recentWrapper.appendChild(grid);
        body.appendChild(recentWrapper);
      }

      const groups = getCategoryGroups();
      groups.forEach((subcategories, category) => {
        const accordion = document.createElement('div');
        accordion.className = 'oee-operator-accordion';
        if (state.openCategories && state.openCategories[category]) {
          accordion.classList.add('oee-accordion-open');
        }

        const headerBtn = document.createElement('button');
        headerBtn.type = 'button';
        headerBtn.className = 'oee-accordion-header';
        headerBtn.innerHTML = `<div>${category}</div><span>${subcategories.size || 1} options</span>`;
        headerBtn.addEventListener('click', (event) => {
          event.preventDefault();
          state.openCategories = state.openCategories || {};
          state.openCategories[category] = !state.openCategories[category];
          editingStates[data.hour] = state;
          renderOperatorView();
        });

        accordion.appendChild(headerBtn);

        const panel = document.createElement('div');
        panel.className = 'oee-accordion-panel';

        const grid = document.createElement('div');
        grid.className = 'oee-accordion-grid';

        const entries = subcategories.size ? Array.from(subcategories) : [''];
        entries.forEach(subcategory => {
          grid.appendChild(buildCauseCard(data.hour, state, category, subcategory));
        });

        panel.appendChild(grid);
        accordion.appendChild(panel);
        body.appendChild(accordion);
      });

      const selectedWrapper = document.createElement('div');
      selectedWrapper.className = 'oee-operator-selected-causes';
      const selectedTitle = document.createElement('strong');
      selectedTitle.textContent = 'Causes s√©lectionn√©es';
      selectedWrapper.appendChild(selectedTitle);

      const list = document.createElement('ul');
      if (state.causes.length === 0) {
        const empty = document.createElement('li');
        empty.textContent = 'Aucune cause pour le moment.';
        list.appendChild(empty);
      } else {
        state.causes.forEach(cause => {
          const item = document.createElement('li');
          const label = document.createElement('span');
          label.textContent = `${cause.category}${cause.subcategory ? ' ‚Ä¢ ' + cause.subcategory : ''}`;
          const value = document.createElement('span');
          value.textContent = formatMinutes(cause.minutes);
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'oee-operator-remove';
          removeBtn.textContent = '‚úñ';
          removeBtn.setAttribute('aria-label', `Retirer ${label.textContent}`);
          removeBtn.addEventListener('click', (event) => {
            event.preventDefault();
            removeCause(data.hour, cause.category, cause.subcategory);
          });
          item.appendChild(label);
          item.appendChild(value);
          item.appendChild(removeBtn);
          list.appendChild(item);
        });
      }

      selectedWrapper.appendChild(list);
      body.appendChild(selectedWrapper);

      const commentDetails = document.createElement('details');
      commentDetails.className = 'oee-operator-comment';
      if (state.comment && state.comment.length > 0) {
        commentDetails.setAttribute('open', '');
      }

      const summary = document.createElement('summary');
      summary.textContent = 'Commentaire';
      const textarea = document.createElement('textarea');
      textarea.value = state.comment || '';
      textarea.placeholder = 'Ajouter une observation...';
      textarea.addEventListener('input', debounce(() => {
        state.comment = textarea.value;
        editingStates[data.hour] = state;
      }, DEBOUNCE_DELAY));

      commentDetails.appendChild(summary);
      commentDetails.appendChild(textarea);
      body.appendChild(commentDetails);

      const warning = document.createElement('div');
      warning.className = 'oee-operator-warning';
      if (stateMetrics.rawOee > 100) {
        warning.textContent = 'V√©rifier la saisie (OEE > 100%)';
        body.appendChild(warning);
      }

      const actions = document.createElement('div');
      actions.className = 'oee-operator-actions';
      const validateBtn = document.createElement('button');
      validateBtn.type = 'button';
      validateBtn.className = 'oee-operator-primary';
      validateBtn.textContent = data.validated ? 'üíæ Enregistrer' : '‚úÖ Valider';
      validateBtn.addEventListener('click', () => {
        saveTile(data.hour);
      });

      const cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'oee-operator-secondary';
      cancelBtn.textContent = 'Annuler';
      cancelBtn.addEventListener('click', () => {
        closeTile(data.hour, { resetState: true });
      });

      actions.appendChild(cancelBtn);
      actions.appendChild(validateBtn);
      body.appendChild(actions);

      return body;
    }

    function getMinutesColorClass(value) {
      if (value <= 15) return 'oee-minutes-green';
      if (value <= 30) return 'oee-minutes-orange';
      return 'oee-minutes-red';
    }

    function adjustProduction(hour, delta) {
      const state = ensureEditingState(hour);
      state.good = Math.max(0, state.good + delta);
      editingStates[hour] = state;
      renderOperatorView();
    }

    function buildCauseCard(hour, state, category, subcategory) {
      const card = document.createElement('div');
      card.className = 'oee-accordion-subcategory';

      const title = document.createElement('strong');
      title.textContent = subcategory ? `${category} ‚Ä¢ ${subcategory}` : category;
      card.appendChild(title);

      const controls = document.createElement('div');
      controls.className = 'oee-accordion-controls';

      const minusBtn = document.createElement('button');
      minusBtn.type = 'button';
      minusBtn.className = 'oee-operator-step';
      minusBtn.textContent = '-5';
      minusBtn.setAttribute('aria-label', `Retirer 5 minutes pour ${title.textContent}`);
      bindCauseIncrement(minusBtn, hour, category, subcategory, -5, -5);

      const value = document.createElement('span');
      value.className = 'oee-accordion-minute-value';
      const existing = state.causes.find(cause => getCauseKey(cause.category, cause.subcategory) === getCauseKey(category, subcategory));
      value.textContent = `${existing ? existing.minutes : 0} min`;

      const plusBtn = document.createElement('button');
      plusBtn.type = 'button';
      plusBtn.className = 'oee-operator-step';
      plusBtn.textContent = '+5';
      plusBtn.setAttribute('aria-label', `Ajouter 5 minutes pour ${title.textContent}`);
      bindCauseIncrement(plusBtn, hour, category, subcategory, 5, 10);

      controls.appendChild(minusBtn);
      controls.appendChild(value);
      controls.appendChild(plusBtn);

      card.appendChild(controls);
      return card;
    }

    function bindCauseIncrement(button, hour, category, subcategory, delta, longDelta) {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        adjustCauseMinutes(hour, category, subcategory, delta);
      });

      let timer = null;
      let longPressTriggered = false;

      button.addEventListener('pointerdown', (event) => {
        event.preventDefault();
        button.setPointerCapture(event.pointerId);
        longPressTriggered = false;
        timer = setTimeout(() => {
          adjustCauseMinutes(hour, category, subcategory, longDelta);
          longPressTriggered = true;
          timer = null;
        }, 600);
      });

      const clearTimer = (shouldTriggerShort) => {
        if (timer) {
          clearTimeout(timer);
          timer = null;
          if (shouldTriggerShort) {
            adjustCauseMinutes(hour, category, subcategory, delta);
          }
        }
      };

      button.addEventListener('pointerup', (event) => {
        event.preventDefault();
        button.releasePointerCapture(event.pointerId);
        clearTimer(!longPressTriggered);
      });

      button.addEventListener('pointerleave', () => {
        if (timer) {
          clearTimeout(timer);
          timer = null;
        }
      });

      button.addEventListener('pointercancel', () => {
        if (timer) {
          clearTimeout(timer);
          timer = null;
        }
      });

      button.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          adjustCauseMinutes(hour, category, subcategory, delta);
        }
      });
    }

    function getCauseKey(category, subcategory) {
      return `${category || ''}__${subcategory || ''}`;
    }

    function adjustCauseMinutes(hour, category, subcategory, delta) {
      const state = ensureEditingState(hour);
      const key = getCauseKey(category, subcategory);
      let cause = state.causes.find(item => getCauseKey(item.category, item.subcategory) === key);

      if (!cause) {
        if (delta <= 0) {
          renderOperatorView();
          return;
        }
        cause = { category, subcategory, minutes: 0 };
        state.causes.push(cause);
      }

      const otherTotal = state.causes
        .filter(item => getCauseKey(item.category, item.subcategory) !== key)
        .reduce((sum, item) => sum + (item.minutes || 0), 0);

      const maxForCause = Math.max(0, 60 - otherTotal);
      const current = clampMinutes(cause.minutes);
      const candidate = clampMinutes(current + delta);

      if (candidate > maxForCause) {
        if (maxForCause === current) {
          showToast('‚è±Ô∏è Limite 60 min atteinte', 'warning');
          renderOperatorView();
          return;
        }
        cause.minutes = maxForCause;
        showToast('‚è±Ô∏è Limite 60 min atteinte', 'warning');
      } else if (candidate <= 0) {
        state.causes = state.causes.filter(item => getCauseKey(item.category, item.subcategory) !== key);
      } else {
        cause.minutes = candidate;
      }

      state.causes = capCausesToSixty(state.causes);
      editingStates[hour] = state;
      renderOperatorView();
    }

    function removeCause(hour, category, subcategory) {
      const state = ensureEditingState(hour);
      const key = getCauseKey(category, subcategory);
      state.causes = state.causes.filter(item => getCauseKey(item.category, item.subcategory) !== key);
      editingStates[hour] = state;
      renderOperatorView();
    }

    function saveTile(hour) {
      const state = ensureEditingState(hour);
      const normalizedCauses = capCausesToSixty(state.causes.map(cause => ({ ...cause })));
      const metrics = calculateTileMetrics({ ...state, causes: normalizedCauses });

      if (metrics.rawOee > 100) {
        showToast('V√©rifier la saisie', 'warning');
        return;
      }

      const previous = normalizeTileData(hourlyData[hour], hour);
      const changes = {};

      if (previous.good !== state.good) {
        changes.good = { from: previous.good, to: state.good };
      }

      if (JSON.stringify(previous.causes) !== JSON.stringify(normalizedCauses)) {
        changes.causes = { from: previous.causes, to: normalizedCauses };
      }

      if ((previous.comment || '') !== (state.comment || '')) {
        changes.comment = { from: previous.comment || '', to: state.comment || '' };
      }

      hourlyData[hour] = {
        hour,
        good: state.good,
        causes: normalizedCauses,
        comment: state.comment || '',
        validated: true,
        edits: Array.isArray(previous.edits) ? [...previous.edits] : []
      };

      if (Object.keys(changes).length === 0) {
        if (!previous.validated) {
          recordEdit(hour, { status: 'validated' });
        }
      } else {
        recordEdit(hour, changes);
      }

      updateRecentSubcategories(normalizedCauses);
      closeTile(hour, { resetState: true });
      triggerValidationPulse(hour);
      updateKPIs();
      updateOperatorRecap();
      updateChart();
      checkBadges();
      celebrate(metrics.oee >= TRS_THRESHOLDS.excellent);
      showToast('‚úÖ Saisie enregistr√©e', 'success');
    }

    function updateRecentSubcategories(causes) {
      causes.forEach(cause => {
        if (!cause.subcategory && !cause.category) return;
        const key = getCauseKey(cause.category, cause.subcategory);
        recentSubcategories = recentSubcategories.filter(item => getCauseKey(item.category, item.subcategory) !== key);
        recentSubcategories.unshift({ category: cause.category, subcategory: cause.subcategory });
      });
      recentSubcategories = recentSubcategories.slice(0, 6);
    }

    function triggerValidationPulse(hour) {
      requestAnimationFrame(() => {
        const tile = document.querySelector(`.oee-operator-tile[data-hour="${hour}"]`);
        if (!tile) return;
        tile.classList.add('oee-operator-pulse');
        setTimeout(() => tile.classList.remove('oee-operator-pulse'), 600);
      });
    }

    function debounce(fn, delay = DEBOUNCE_DELAY) {
      let timeout;
      return function debounced(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    function getCategoryGroups() {
      const groups = new Map();
      CATEGORY_DATA.forEach(item => {
        const category = (item.category || 'Divers').trim() || 'Divers';
        const subcategory = (item.subcategory || '').trim();
        if (!groups.has(category)) {
          groups.set(category, new Set());
        }
        if (subcategory) {
          groups.get(category).add(subcategory);
        }
      });

      if (!groups.size) {
        groups.set('Divers', new Set());
      }

      return groups;
    }

    function buildTeamAssignmentsTable() {
      const tbody = document.getElementById('team-assignments-body');
      if (!tbody) return;

      tbody.innerHTML = '';
      for (let i = 0; i < 24; i++) {
        const row = document.createElement('tr');
        const hourCell = document.createElement('td');
        hourCell.textContent = `${String(i).padStart(2, '0')}h`;

        const teamCell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = TEAM_ASSIGNMENTS[i] || '';
        input.dataset.teamHour = i;
        input.placeholder = '√âquipe';

        teamCell.appendChild(input);
        row.appendChild(hourCell);
        row.appendChild(teamCell);
        tbody.appendChild(row);
      }
    }

    function populateParameters() {
      const targetRateInput = document.getElementById('target-rate');
      if (targetRateInput) {
        targetRateInput.value = parseInt(targetRateInput.value, 10) || 16000;
      }

      const excellentInput = document.getElementById('threshold-excellent');
      const goodInput = document.getElementById('threshold-good');
      const lowInput = document.getElementById('threshold-low');

      if (excellentInput) excellentInput.value = TRS_THRESHOLDS.excellent;
      if (goodInput) goodInput.value = TRS_THRESHOLDS.good;
      if (lowInput) lowInput.value = Math.max(0, TRS_THRESHOLDS.good - 1);

      buildTeamAssignmentsTable();
      buildCategoryTable();
    }

    function saveSettings() {
      const targetRateInput = document.getElementById('target-rate');
      if (targetRateInput) {
        let rateValue = parseInt(targetRateInput.value, 10);
        if (!Number.isFinite(rateValue) || rateValue <= 0) {
          rateValue = 16000;
        }
        targetRateInput.value = rateValue;
        targetRateInput.dispatchEvent(new Event('change'));
      }

      document.querySelectorAll('#team-assignments-body input').forEach(input => {
        const hour = parseInt(input.dataset.teamHour, 10);
        if (Number.isInteger(hour)) {
          const value = input.value.trim();
          TEAM_ASSIGNMENTS[hour] = value || DEFAULT_TEAM_ASSIGNMENTS[hour];
          input.value = TEAM_ASSIGNMENTS[hour];
        }
      });

      let excellent = parseInt(document.getElementById('threshold-excellent').value, 10);
      let good = parseInt(document.getElementById('threshold-good').value, 10);

      if (!Number.isFinite(excellent)) excellent = TRS_THRESHOLDS.excellent;
      if (!Number.isFinite(good)) good = TRS_THRESHOLDS.good;

      excellent = Math.max(0, Math.min(100, excellent));
      good = Math.max(0, Math.min(100, good));

      if (excellent < good) {
        excellent = good;
      }

      TRS_THRESHOLDS.excellent = excellent;
      TRS_THRESHOLDS.good = Math.min(excellent, good);

      document.getElementById('threshold-excellent').value = TRS_THRESHOLDS.excellent;
      document.getElementById('threshold-good').value = TRS_THRESHOLDS.good;
      document.getElementById('threshold-low').value = Math.max(0, TRS_THRESHOLDS.good - 1);

      buildTeamAssignmentsTable();
      refreshDisplay();
      checkBadges();
      showToast('üíæ Param√®tres appliqu√©s', 'success');
    }

    function exportConfig() {
      const config = {
        targetRate: parseInt(document.getElementById('target-rate').value, 10) || 16000,
        teamAssignments: [...TEAM_ASSIGNMENTS],
        thresholds: { ...TRS_THRESHOLDS },
        categories: CATEGORY_DATA.map(item => ({
          category: item.category,
          subcategory: item.subcategory
        }))
      };

      const dateStr = new Date().toISOString().split('T')[0];
      downloadJSON(config, `config-production-${dateStr}.json`);
      showToast('üì§ Configuration export√©e', 'success');
    }

    function importConfig(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const config = JSON.parse(event.target.result);

          if (typeof config.targetRate === 'number' && Number.isFinite(config.targetRate)) {
            const targetRateInput = document.getElementById('target-rate');
            if (targetRateInput) {
              targetRateInput.value = Math.max(0, Math.round(config.targetRate));
              targetRateInput.dispatchEvent(new Event('change'));
            }
          }

          if (Array.isArray(config.teamAssignments) && config.teamAssignments.length === 24) {
            TEAM_ASSIGNMENTS = config.teamAssignments.map((team, index) => {
              const value = typeof team === 'string' ? team.trim() : '';
              return value || DEFAULT_TEAM_ASSIGNMENTS[index];
            });
          }

          if (Array.isArray(config.categories)) {
            CATEGORY_DATA = config.categories.map(item => ({
              category: typeof item.category === 'string' ? item.category.trim() : '',
              subcategory: typeof item.subcategory === 'string' ? item.subcategory.trim() : ''
            }));
            buildCategoryTable();
            rebuildQuickCauses();
          }

          if (config.thresholds && typeof config.thresholds === 'object') {
            const { excellent, good } = config.thresholds;

            if (Number.isFinite(excellent)) {
              TRS_THRESHOLDS.excellent = Math.max(0, Math.min(100, Math.round(excellent)));
            }
            if (Number.isFinite(good)) {
              TRS_THRESHOLDS.good = Math.max(0, Math.min(TRS_THRESHOLDS.excellent, Math.round(good)));
            }

            if (TRS_THRESHOLDS.excellent < TRS_THRESHOLDS.good) {
              TRS_THRESHOLDS.excellent = TRS_THRESHOLDS.good;
            }
          }

          populateParameters();
          refreshDisplay();
          checkBadges();
          showToast('üì• Configuration import√©e', 'success');
        } catch (error) {
          console.error('Erreur import configuration', error);
          showToast('‚ùå Import impossible', 'error');
        }
      };

      reader.readAsText(file);
    }

    function resetDay() {
      hourlyData = createEmptyHourlyData();
      unlockedBadges = new Set();
      document.querySelectorAll('.badge').forEach(badge => badge.classList.remove('unlocked'));
      Object.keys(editingStates).forEach(key => delete editingStates[key]);
      recentSubcategories = [];
      quickEditHour = null;
      visibleDropdownHour = null;
      visibleHistoryHour = null;
      openTileHour = null;
      activeTeam = determineInitialActiveTeam();
      refreshDisplay();
      checkBadges();
      showToast('üßπ Journ√©e r√©initialis√©e', 'success');
    }


    // Actualisation de l'affichage
    function refreshDisplay() {
      renderOperatorView();
      updateKPIs();
      updateChart();
      highlightCurrentHour();
    }

    // KPIs
    function updateKPIs() {
      const validatedData = hourlyData.filter(d => d.validated);
      
      if (validatedData.length === 0) {
        document.getElementById('kpi-trs').textContent = '0%';
        document.getElementById('kpi-availability').textContent = '0%';
        document.getElementById('kpi-performance').textContent = '0%';
        document.getElementById('kpi-total').textContent = '0';
        return;
      }
      
      let totalAvail = 0, totalPerf = 0;
      let totalProduction = 0;
      let totalOee = 0;

      validatedData.forEach(data => {
        const metrics = calculateTileMetrics(data);
        totalAvail += metrics.availability;
        totalPerf += metrics.performance;
        totalOee += metrics.oee;
        totalProduction += data.good;
      });

      const avgAvail = totalAvail / validatedData.length;
      const avgPerf = totalPerf / validatedData.length;
      const avgOee = totalOee / validatedData.length;

      document.getElementById('kpi-trs').textContent = `${Math.round(avgOee)}%`;
      document.getElementById('kpi-availability').textContent = `${Math.round(avgAvail * 100)}%`;
      document.getElementById('kpi-performance').textContent = `${Math.round(avgPerf * 100)}%`;
      document.getElementById('kpi-total').textContent = totalProduction.toLocaleString('fr-FR');
      
      // Mise √† jour de la tendance
      const targetDaily = 24 * (parseInt(document.getElementById('target-rate').value) || 16000);
      document.getElementById('target-trend').innerHTML = `
        <span>${totalProduction >= targetDaily ? '‚Üó' : '‚Üí'}</span> 
        Objectif: ${(targetDaily / 1000).toFixed(0)}k
      `;
    }

    // Graphique Chart.js
    function initChart() {
      const ctx = document.getElementById('production-chart').getContext('2d');
      
      currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}h`),
          datasets: [
            {
              label: 'Production R√©elle',
              data: Array(24).fill(0),
              backgroundColor: 'rgba(99, 102, 241, 0.6)',
              borderColor: 'rgba(99, 102, 241, 1)',
              borderWidth: 2,
              borderRadius: 8
            },
            {
              label: 'Cible',
              data: Array(24).fill(16000),
              type: 'line',
              borderColor: 'rgba(245, 158, 11, 1)',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 3,
              pointRadius: 0,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#f1f5f9',
                font: { size: 14, weight: 600 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(30, 41, 59, 0.95)',
              titleColor: '#f1f5f9',
              bodyColor: '#f1f5f9',
              borderColor: 'rgba(99, 102, 241, 0.5)',
              borderWidth: 1,
              padding: 12,
              displayColors: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              },
              ticks: {
                color: '#94a3b8'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#94a3b8'
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    function updateChart() {
      if (!currentChart) return;

      try {
        const targetRate = parseInt(document.getElementById('target-rate').value) || 16000;
        const productionData = hourlyData.map(d => d.validated ? d.good : 0);

        currentChart.data.datasets[0].data = productionData;
        currentChart.data.datasets[1].data = Array(24).fill(targetRate);
        currentChart.update();
      } catch (error) {
        console.error('Erreur mise √† jour graphique', error);
      }
    }

    // Syst√®me de badges
    function checkBadges() {
      const validatedData = hourlyData.filter(d => d.validated);
      
      // Badge: Heure Parfaite (TRS >= 100%)
      validatedData.forEach(data => {
        const metrics = calculateTileMetrics(data);
        if (metrics.oee >= 100) {
          unlockBadge('perfect-hour');
        }
        if (metrics.downtime === 0) {
          unlockBadge('zero-downtime');
        }
      });

      // Badge: Streak (3 heures cons√©cutives >= 90%)
      let streak = 0;
      for (let i = 0; i < 24; i++) {
        if (hourlyData[i].validated && calculateTileMetrics(hourlyData[i]).oee >= 90) {
          streak++;
          if (streak >= 3) {
            unlockBadge('streak-3');
            break;
          }
        } else {
          streak = 0;
        }
      }

      // Badge: Champion √âquipe (moyenne √©quipe > 95%)
      const teams = {};
      validatedData.forEach(data => {
        const team = TEAM_ASSIGNMENTS[data.hour];
        if (!teams[team]) teams[team] = [];
        teams[team].push(calculateTileMetrics(data).oee);
      });

      Object.values(teams).forEach(trsList => {
        const avg = trsList.reduce((a, b) => a + b, 0) / trsList.length;
        if (avg >= 95) {
          unlockBadge('team-champion');
        }
      });
      
      // Badge: R√©gularit√© (√©cart-type faible)
      if (validatedData.length >= 8) {
        const trsList = validatedData.map(d => calculateTileMetrics(d).oee);
        const avg = trsList.reduce((a, b) => a + b, 0) / trsList.length;
        const variance = trsList.reduce((sum, trs) => sum + Math.pow(trs - avg, 2), 0) / trsList.length;
        const stdDev = Math.sqrt(variance);

        if (stdDev < 5) {
          unlockBadge('consistency');
        }
      }
    }

    function unlockBadge(badgeId) {
      if (unlockedBadges.has(badgeId)) return;
      
      unlockedBadges.add(badgeId);
      const badge = document.querySelector(`[data-badge="${badgeId}"]`);
      if (badge) {
        badge.classList.add('unlocked');
        showToast(`üèÜ Badge d√©bloqu√©: ${badge.querySelector('.badge-label').textContent}`, 'success');
      }
    }

    // C√©l√©bration
    function celebrate(isExcellent) {
      if (!isExcellent) return;
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          createConfetti();
        }, i * 30);
      }
    }

    function createConfetti() {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * window.innerWidth + 'px';
      confetti.style.top = '-10px';
      confetti.style.background = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'][Math.floor(Math.random() * 5)];
      confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
      document.body.appendChild(confetti);
      
      setTimeout(() => confetti.remove(), 3000);
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
    document.getElementById('import-config-btn').addEventListener('click', () => {
      document.getElementById('config-import-input').click();
    });

    document.getElementById('config-import-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      importConfig(file);
      event.target.value = '';
    });

    document.getElementById('export-config-btn').addEventListener('click', exportConfig);
    document.getElementById('reset-day-btn').addEventListener('click', resetDay);
    document.getElementById('add-category-row-btn').addEventListener('click', addCategoryRow);
    document.getElementById('save-categories-btn').addEventListener('click', saveCategoriesList);
    document.getElementById('export-categories-btn').addEventListener('click', exportCategories);
    document.getElementById('import-categories-btn').addEventListener('click', () => {
      document.getElementById('categories-import-input').click();
    });
    document.getElementById('categories-import-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      importCategories(file);
      event.target.value = '';
    });

    // Boutons d'action
    document.getElementById('refresh-btn').addEventListener('click', () => {
      refreshDisplay();
      showToast('üîÑ Donn√©es actualis√©es', 'success');
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      const csvData = generateCSV();
      downloadCSV(csvData, getCSVFilename());
      showToast('üìä Export r√©ussi', 'success');
    });

    function generateCSV() {
      const rows = [['Heure', '√âquipe', 'Production', 'TRS%', 'Commentaire']];

      hourlyData.forEach(data => {
        if (data.validated) {
          rows.push([
            `${String(data.hour).padStart(2, '0')}:00`,
            TEAM_ASSIGNMENTS[data.hour],
            data.good,
            calculateTileMetrics(data).oee,
            data.comment || ''
          ]);
        }
      });
      
      return rows.map(row => row.join(';')).join('\n');
    }

    function getCSVFilename() {
      const dateStr = new Date().toISOString().split('T')[0];
      return `production-${dateStr}.csv`;
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      setTimeout(() => URL.revokeObjectURL(link.href), 100);
    }

    function downloadJSON(content, filename) {
      const blob = new Blob([JSON.stringify(content, null, 2)], { type: 'application/json;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      setTimeout(() => URL.revokeObjectURL(link.href), 100);
    }

    function buildCategoryTable() {
      const tbody = document.getElementById('categories-table-body');
      if (!tbody) return;

      tbody.innerHTML = '';

      CATEGORY_DATA.forEach((item, index) => {
        const row = document.createElement('tr');

        const categoryCell = document.createElement('td');
        const categoryInput = document.createElement('input');
        categoryInput.type = 'text';
        categoryInput.value = item.category || '';
        categoryInput.dataset.field = 'category';
        categoryCell.appendChild(categoryInput);

        const subcategoryCell = document.createElement('td');
        const subcategoryInput = document.createElement('input');
        subcategoryInput.type = 'text';
        subcategoryInput.value = item.subcategory || '';
        subcategoryInput.dataset.field = 'subcategory';
        subcategoryCell.appendChild(subcategoryInput);

        const actionsCell = document.createElement('td');
        actionsCell.style.whiteSpace = 'nowrap';
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-secondary';
        deleteBtn.textContent = 'üóëÔ∏è Supprimer';
        deleteBtn.addEventListener('click', () => removeCategoryRow(index));
        actionsCell.appendChild(deleteBtn);

        row.appendChild(categoryCell);
        row.appendChild(subcategoryCell);
        row.appendChild(actionsCell);

        tbody.appendChild(row);
      });
    }

    function getCategoriesFromTable() {
      const rows = document.querySelectorAll('#categories-table-body tr');
      if (!rows.length) {
        return [...CATEGORY_DATA];
      }

      return Array.from(rows).map(row => {
        const categoryInput = row.querySelector('input[data-field="category"]');
        const subcategoryInput = row.querySelector('input[data-field="subcategory"]');
        return {
          category: categoryInput ? categoryInput.value.trim() : '',
          subcategory: subcategoryInput ? subcategoryInput.value.trim() : ''
        };
      });
    }

    function addCategoryRow() {
      CATEGORY_DATA = getCategoriesFromTable();
      CATEGORY_DATA.push({ category: '', subcategory: '' });
      buildCategoryTable();
    }

    function removeCategoryRow(index) {
      const current = getCategoriesFromTable();
      CATEGORY_DATA = current.filter((_, idx) => idx !== index);
      buildCategoryTable();
      rebuildQuickCauses();
    }

    function saveCategoriesList() {
      CATEGORY_DATA = getCategoriesFromTable().map(item => ({
        category: item.category,
        subcategory: item.subcategory
      }));
      buildCategoryTable();
      rebuildQuickCauses();
      showToast('üíæ Cat√©gories enregistr√©es', 'success');
    }

    function exportCategories() {
      CATEGORY_DATA = getCategoriesFromTable();
      downloadJSON({ categories: CATEGORY_DATA }, 'categories.json');
      showToast('üì§ Cat√©gories export√©es', 'success');
    }

    function importCategories(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const parsed = JSON.parse(event.target.result);
          const categories = Array.isArray(parsed)
            ? parsed
            : (Array.isArray(parsed.categories) ? parsed.categories : null);

          if (!categories) {
            throw new Error('Format cat√©gories invalide');
          }

          CATEGORY_DATA = categories.map(item => ({
            category: typeof item.category === 'string' ? item.category.trim() : '',
            subcategory: typeof item.subcategory === 'string' ? item.subcategory.trim() : ''
          }));

          buildCategoryTable();
          rebuildQuickCauses();
          showToast('üì• Cat√©gories import√©es', 'success');
        } catch (error) {
          console.error('Erreur import cat√©gories', error);
          showToast('‚ùå Import cat√©gories impossible', 'error');
        }
      };

      reader.readAsText(file);
    }

    function rebuildQuickCauses() {
      renderOperatorView();
    }

    // Mise √† jour cadence cible
    document.getElementById('target-rate').addEventListener('change', () => {
      updateKPIs();
      updateChart();
    });
  </script>
</body>
</html>