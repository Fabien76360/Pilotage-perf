<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Production - Pilotage Atelier</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #0f172a;
      --card: rgba(30, 41, 59, 0.8);
      --card-light: rgba(51, 65, 85, 0.6);
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.2);
      --glass: rgba(255, 255, 255, 0.05);
      --glow: rgba(99, 102, 241, 0.3);
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header moderne */
    header {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2rem;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.75rem;
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .view-tabs {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-active {
      box-shadow: 0 0 0 2px var(--primary);
    }

    .btn {
      padding: 0.65rem 1.25rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(99, 102, 241, 0.6);
    }

    .btn-secondary {
      background: var(--card-light);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--glass);
      border-color: var(--primary);
    }

    /* Container principal */
    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      gap: 2rem;
    }

    /* KPI Cards avec glassmorphism */
    .kpi-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .kpi-card {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.6s ease;
    }

    .kpi-card:hover::before {
      transform: scaleX(1);
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: var(--primary);
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .kpi-title {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .kpi-icon {
      font-size: 2rem;
      filter: drop-shadow(0 0 10px currentColor);
    }

    .kpi-value {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .kpi-trend {
      font-size: 0.85rem;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .kpi-trend.negative {
      color: var(--danger);
    }

    /* Badges et achievements */
    .badges-section {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .badges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .badge {
      background: var(--card-light);
      border-radius: 1rem;
      padding: 1.5rem 1rem;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .badge.unlocked {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .badge-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      filter: grayscale(100%);
      opacity: 0.3;
    }

    .badge.unlocked .badge-icon {
      filter: grayscale(0%);
      opacity: 1;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .badge-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .badge.unlocked .badge-label {
      color: var(--success);
    }

    /* Vue op√©rateur 3 colonnes */
    .operator-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      align-items: flex-start;
    }

    .team-column {
      background: linear-gradient(155deg, rgba(30, 41, 59, 0.85) 0%, rgba(15, 23, 42, 0.75) 100%);
      border-radius: 1.5rem;
      border: 1px solid var(--border);
      backdrop-filter: blur(24px);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 220px);
      overflow: hidden;
      position: relative;
    }

    .team-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      position: sticky;
      top: 0;
      z-index: 2;
      background: inherit;
      backdrop-filter: inherit;
    }

    .team-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      font-weight: 700;
      font-size: 1.2rem;
    }

    .team-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .team-metrics strong {
      display: block;
      color: var(--text);
      font-size: 1.25rem;
      font-weight: 700;
    }

    .team-progress {
      height: 8px;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .team-progress span {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
      transition: width 0.4s ease;
    }

    .team-hours {
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .hour-tile {
      background: radial-gradient(circle at top, rgba(99, 102, 241, 0.16), rgba(15, 23, 42, 0.55));
      border-radius: 1.25rem;
      border: 1px solid rgba(99, 102, 241, 0.15);
      padding: 1rem 1.25rem;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
      cursor: pointer;
    }

    .hour-tile::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 2px solid transparent;
      pointer-events: none;
      transition: border-color 0.25s ease;
    }

    .hour-tile:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 35px rgba(15, 23, 42, 0.45);
    }

    .hour-tile.is-empty {
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.4);
      background: rgba(30, 41, 59, 0.35);
    }

    .hour-tile.is-empty .tile-placeholder {
      color: var(--text-muted);
      font-size: 0.9rem;
      text-align: center;
    }

    .hour-tile.is-editing::after {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.35);
    }

    .hour-tile.is-current::after {
      border-color: rgba(129, 140, 248, 0.8);
      box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
    }

    .hour-tile.is-validated::after {
      border-color: rgba(16, 185, 129, 0.6);
    }

    .hour-tile[data-oee-zone="warning"]::after {
      border-color: rgba(245, 158, 11, 0.6);
    }

    .hour-tile[data-oee-zone="danger"]::after {
      border-color: rgba(239, 68, 68, 0.6);
    }

    .tile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }

    .tile-time {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .tile-team {
      font-size: 0.75rem;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .tile-oee {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .tile-oee small {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .tile-micro-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.75rem;
    }

    .tile-badge {
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 600;
    }

    .tile-causes {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .tile-actions {
      display: flex;
      gap: 0.35rem;
      margin-left: auto;
    }

    .tile-icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.55);
      color: var(--text);
      display: grid;
      place-items: center;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tile-icon-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .hour-editor {
      background: rgba(15, 23, 42, 0.75);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 1rem 1.25rem;
      display: none;
      flex-direction: column;
      gap: 1.25rem;
      animation: fadeIn 0.3s ease;
    }

    .hour-tile.is-editing .hour-editor {
      display: flex;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .editor-header h3 {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .editor-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.85rem;
    }

    .editor-metrics span {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 0.75rem;
      padding: 0.35rem 0.75rem;
      font-weight: 600;
    }

    .editor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .editor-block {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    .editor-block label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .editor-input {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(99, 102, 241, 0.25);
      border-radius: 0.85rem;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .editor-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
    }

    .availability-bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      overflow: hidden;
      position: relative;
    }

    .availability-bar span {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      border-radius: inherit;
      transition: width 0.3s ease;
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.8), rgba(99, 102, 241, 0.8));
    }

    .availability-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .cause-accordions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .cause-accordion {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 0.85rem;
      overflow: hidden;
      background: rgba(30, 41, 59, 0.4);
    }

    .accordion-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.85rem 1rem;
      background: rgba(99, 102, 241, 0.15);
      border: none;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }

    .accordion-header span {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .accordion-content.open {
      padding: 0.75rem 1rem 1rem;
      max-height: 700px;
      gap: 0.75rem;
    }

    .cause-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.75rem;
      align-items: center;
      font-size: 0.9rem;
    }

    .cause-controls {
      display: inline-flex;
      gap: 0.4rem;
      align-items: center;
    }

    .cause-button {
      width: 36px;
      height: 36px;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      color: var(--text);
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .cause-button:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .cause-counter {
      min-width: 42px;
      text-align: center;
      font-weight: 600;
    }

    .quick-picks {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .quick-pick {
      padding: 0.45rem 0.8rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .quick-pick:hover {
      background: rgba(99, 102, 241, 0.3);
      transform: translateY(-1px);
    }

    .comment-block {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .comment-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .comment-toggle span {
      font-weight: 600;
      color: var(--text);
    }

    .comment-area {
      display: none;
      background: rgba(15, 23, 42, 0.65);
      border-radius: 0.85rem;
      border: 1px solid rgba(99, 102, 241, 0.2);
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      color: var(--text);
      min-height: 90px;
      resize: vertical;
    }

    .comment-area.open {
      display: block;
    }

    .editor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .editor-actions .btn {
      flex: 1 1 140px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .history-panel {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: min(280px, 90vw);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.85rem;
      padding: 0.75rem 1rem;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.6);
      display: none;
      z-index: 5;
    }

    .history-panel.open {
      display: block;
    }

    .history-panel h4 {
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      font-weight: 700;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8rem;
    }

    .history-entry {
      padding: 0.55rem 0.65rem;
      border-radius: 0.75rem;
      background: rgba(99, 102, 241, 0.15);
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .history-actions {
      margin-top: 0.75rem;
      display: flex;
      justify-content: flex-end;
    }

    .history-actions button {
      background: transparent;
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: var(--danger);
      border-radius: 0.65rem;
      padding: 0.35rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
    }

    .downtime-warning {
      font-size: 0.8rem;
      color: var(--danger);
      font-weight: 600;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Chart section */
    .chart-section {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 1px solid var(--border);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    canvas {
      max-height: 350px;
    }

    /* Confetti celebration */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--success);
      position: absolute;
      animation: confetti-fall 3s linear forwards;
    }

    @keyframes confetti-fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .kpi-section {
        grid-template-columns: 1fr;
      }
      
      .operator-layout {
        grid-template-columns: 1fr;
      }
      
      .badges-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Section titles */
    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 2rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
      border-radius: 2px;
    }

    [data-view] {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .settings-section {
      background: var(--card);
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      border: 1px solid var(--border);
      padding: 2rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .settings-card {
      background: var(--card-light);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .settings-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
    }

    .settings-description {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .table-wrapper {
      max-height: 320px;
      overflow-y: auto;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }

    .settings-table {
      width: 100%;
      border-collapse: collapse;
    }

    .settings-table th,
    .settings-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--text-muted);
      text-align: left;
    }

    .settings-table tr:last-child td {
      border-bottom: none;
    }

    .settings-table td input {
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-weight: 600;
    }

    .settings-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .threshold-fields {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .threshold-fields label {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .threshold-fields input {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>üè≠ Dashboard Production Atelier</h1>
      <div class="header-actions">
        <div class="controls">
          <button class="btn btn-secondary" id="export-btn">üìä Exporter</button>
          <button class="btn btn-primary" id="refresh-btn">üîÑ Actualiser</button>
        </div>
        <div class="view-tabs">
          <button class="btn btn-secondary" data-nav="operateur">Op√©rateur</button>
          <button class="btn btn-secondary" data-nav="analyse">Analyse</button>
          <button class="btn btn-secondary" data-nav="parametres">Param√®tres</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div data-view="operateur">
      <section>
        <h2 class="section-title">üìÖ Production Horaire</h2>
        <div class="operator-layout" id="operator-columns"></div>
      </section>
    </div>

    <div data-view="analyse">
      <!-- KPI Cards -->
      <section class="kpi-section">
      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">TRS Global</span>
          <span class="kpi-icon">‚ö°</span>
        </div>
        <div class="kpi-value" id="kpi-trs">0%</div>
        <div class="kpi-trend" id="trs-trend">
          <span>‚Üó</span> +2.3% vs hier
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Disponibilit√©</span>
          <span class="kpi-icon">üéØ</span>
        </div>
        <div class="kpi-value" id="kpi-availability">0%</div>
        <div class="kpi-trend">
          <span>‚Üí</span> Stable
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Performance</span>
          <span class="kpi-icon">üöÄ</span>
        </div>
        <div class="kpi-value" id="kpi-performance">0%</div>
        <div class="kpi-trend">
          <span>‚Üó</span> +1.5% vs hier
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span class="kpi-title">Production Journ√©e</span>
          <span class="kpi-icon">üì¶</span>
        </div>
        <div class="kpi-value" id="kpi-total">0</div>
        <div class="kpi-trend" id="target-trend">
          <span>‚Üí</span> Objectif: 384k
        </div>
      </div>
    </section>

    <!-- Badges Section -->
    <section class="badges-section">
      <h2 class="section-title">üèÜ Achievements</h2>
      <div class="badges-grid" id="badges-grid">
        <div class="badge" data-badge="perfect-hour">
          <div class="badge-icon">üåü</div>
          <div class="badge-label">Heure Parfaite</div>
        </div>
        <div class="badge" data-badge="zero-downtime">
          <div class="badge-icon">‚ö°</div>
          <div class="badge-label">Z√©ro Arr√™t</div>
        </div>
        <div class="badge" data-badge="streak-3">
          <div class="badge-icon">üî•</div>
          <div class="badge-label">Streak x3</div>
        </div>
        <div class="badge" data-badge="team-champion">
          <div class="badge-icon">üëë</div>
          <div class="badge-label">Champion √âquipe</div>
        </div>
        <div class="badge" data-badge="consistency">
          <div class="badge-icon">üíé</div>
          <div class="badge-label">R√©gularit√©</div>
        </div>
      </div>
    </section>
    <!-- Chart Section -->
    <section class="chart-section">
      <div class="chart-header">
        <h2 class="chart-title">üìà Performance en Temps R√©el</h2>
      </div>
      <canvas id="production-chart"></canvas>
    </section>
    </div>

    <div data-view="parametres">
      <section class="settings-section">
        <h2 class="section-title">‚öôÔ∏è Param√®tres</h2>
        <div class="settings-grid">
          <div class="settings-card">
            <div class="settings-title">Cadence cible</div>
            <div class="settings-description">D√©finissez la cadence horaire nominale utilis√©e pour calculer les TRS et les justifications.</div>
            <div>
              <label style="color: var(--text-muted); font-size: 0.9rem; font-weight: 600; display: flex; flex-direction: column; gap: 0.5rem;">
                Cadence (u/h)
                <input type="number" id="target-rate" value="16000" style="width: 100%; background: var(--card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 0.5rem 0.75rem; color: var(--text);" />
              </label>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Affectation des √©quipes</div>
            <div class="settings-description">Ajustez l'√©quipe responsable de chaque tranche horaire pour un suivi pr√©cis.</div>
            <div class="table-wrapper">
              <table class="settings-table">
                <thead>
                  <tr>
                    <th>Heure</th>
                    <th>√âquipe</th>
                  </tr>
                </thead>
                <tbody id="team-assignments-body"></tbody>
              </table>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Cat√©gories &amp; Sous-cat√©gories</div>
            <div class="settings-description">D√©finissez les cat√©gories et sous-cat√©gories d‚Äô√©v√©nements (ex : Machine &gt; D√©pileuse). Ces √©l√©ments seront utilis√©s dans les causes d‚Äôarr√™t.</div>
            <div class="table-wrapper">
              <table class="settings-table">
                <thead>
                  <tr>
                    <th>Cat√©gorie</th>
                    <th>Sous-cat√©gorie</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="categories-table-body"></tbody>
              </table>
            </div>
            <div class="settings-actions">
              <button class="btn btn-secondary" id="add-category-row-btn">‚ûï Ajouter une ligne</button>
              <button class="btn btn-primary" id="save-categories-btn">üíæ Sauvegarder</button>
              <button class="btn btn-secondary" id="export-categories-btn">üì§ Exporter</button>
              <button class="btn btn-secondary" id="import-categories-btn">üì• Importer</button>
              <input type="file" id="categories-import-input" accept="application/json" style="display: none;" />
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Seuils TRS</div>
            <div class="settings-description">Personnalisez les seuils de performance utilis√©s pour colorer les cartes horaires.</div>
            <div class="threshold-fields">
              <label>
                Excellent (‚â• %)
                <input type="number" id="threshold-excellent" min="0" max="100" value="95" />
              </label>
              <label>
                Bon (‚â• %)
                <input type="number" id="threshold-good" min="0" max="100" value="85" />
              </label>
              <label>
                Faible (&lt; %)
                <input type="number" id="threshold-low" min="0" max="100" value="85" disabled style="opacity: 0.6; cursor: not-allowed;" />
              </label>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-title">Gestion</div>
            <div class="settings-description">Sauvegardez vos r√©glages ou r√©initialisez la journ√©e en cours.</div>
            <div class="settings-actions">
              <button class="btn btn-primary" id="save-settings-btn">üíæ Sauvegarder param√®tres</button>
              <button class="btn btn-secondary" id="import-config-btn">üì• Importer config</button>
              <button class="btn btn-secondary" id="export-config-btn">üì§ Exporter config</button>
              <button class="btn btn-secondary" id="reset-day-btn">üßπ R√©initialiser journ√©e</button>
              <input type="file" id="config-import-input" accept="application/json" style="display: none;" />
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const DEFAULT_VIEW = 'operateur';
    const DEFAULT_TEAM_ASSIGNMENTS = [
      'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit', 'Equipe Nuit',
      'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour', 'Equipe Jour',
      'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir', 'Equipe Soir'
    ];

    let TEAM_ASSIGNMENTS = [...DEFAULT_TEAM_ASSIGNMENTS];
    let TRS_THRESHOLDS = { excellent: 95, good: 85 };
    let CATEGORY_DATA = [
      { category: 'Machine', subcategory: 'D√©pileuse' },
      { category: 'Machine', subcategory: 'MASS' }
    ];

    const TEAM_ORDER = ['Equipe Nuit', 'Equipe Jour', 'Equipe Soir'];
    const QUALITY_TRACKING = true;
    const MAX_HISTORY_ENTRIES = 10;
    const CAUSE_STEP = 5;
    const CAUSE_LONG_STEP = 10;
    const CAUSE_LONG_DELAY = 600;

    // √âtat global en m√©moire (PAS de localStorage)
    function createEmptyHourlyData() {
      return new Array(24).fill(null).map((_, i) => ({
        hour: i,
        good: 0,
        scrap: 0,
        causes: [],
        comment: '',
        validated: false,
        history: []
      }));
    }

    let hourlyData = createEmptyHourlyData();

    const CHANGELOG = [];

    function bump(level, messages) {
      const entry = {
        level,
        messages: Array.isArray(messages) ? messages : [messages],
        timestamp: new Date().toISOString()
      };
      CHANGELOG.push(entry);
      console.info('[CHANGELOG]', entry);
      return entry;
    }

    let edits = [];
    let recentSubcategories = [];
    const openTileByTeam = new Map();

    let currentChart = null;
    let unlockedBadges = new Set();

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      buildHoursGrid();
      updateKPIs();
      initChart();
      highlightCurrentHour();
      checkBadges();
      buildTeamAssignmentsTable();
      buildCategoryTable();
      rebuildQuickCauses();
      populateParameters();
      setupNavigation();

      document.addEventListener('click', handleDocumentClick);

      setInterval(highlightCurrentHour, 60000);

      showView(location.hash.replace('#', '') || DEFAULT_VIEW);
    });

    window.addEventListener('hashchange', () => {
      const view = location.hash.replace('#', '') || DEFAULT_VIEW;
      showView(view);
    });

    function showView(view) {
      document.querySelectorAll('[data-view]').forEach(v => {
        v.style.display = 'none';
      });

      const normalized = ['operateur', 'analyse', 'parametres'].includes(view) ? view : DEFAULT_VIEW;
      const element = document.querySelector(`[data-view="${normalized}"]`) || document.querySelector('[data-view="operateur"]');
      if (element) {
        element.style.display = '';
      }

      setActiveTab(normalized);

      if (normalized === 'operateur') {
        refreshDisplay();
      }

      if (normalized === 'analyse') {
        refreshDisplay();
        updateChart();
      }

      if (normalized === 'parametres') {
        populateParameters();
      }
    }

    function setActiveTab(view) {
      document.querySelectorAll('[data-nav]').forEach(btn => btn.classList.remove('btn-active'));
      const activeBtn = document.querySelector(`[data-nav="${view}"]`);
      if (activeBtn) {
        activeBtn.classList.add('btn-active');
      }
    }

    function setupNavigation() {
      document.querySelectorAll('[data-nav]').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetView = btn.dataset.nav;
          if (targetView) {
            location.hash = `#${targetView}`;
          }
        });
      });
    }

    function buildTeamAssignmentsTable() {
      const tbody = document.getElementById('team-assignments-body');
      if (!tbody) return;

      tbody.innerHTML = '';
      for (let i = 0; i < 24; i++) {
        const row = document.createElement('tr');
        const hourCell = document.createElement('td');
        hourCell.textContent = `${String(i).padStart(2, '0')}h`;

        const teamCell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = TEAM_ASSIGNMENTS[i] || '';
        input.dataset.teamHour = i;
        input.placeholder = '√âquipe';

        teamCell.appendChild(input);
        row.appendChild(hourCell);
        row.appendChild(teamCell);
        tbody.appendChild(row);
      }
    }

    function populateParameters() {
      const targetRateInput = document.getElementById('target-rate');
      if (targetRateInput) {
        targetRateInput.value = parseInt(targetRateInput.value, 10) || 16000;
      }

      const excellentInput = document.getElementById('threshold-excellent');
      const goodInput = document.getElementById('threshold-good');
      const lowInput = document.getElementById('threshold-low');

      if (excellentInput) excellentInput.value = TRS_THRESHOLDS.excellent;
      if (goodInput) goodInput.value = TRS_THRESHOLDS.good;
      if (lowInput) lowInput.value = Math.max(0, TRS_THRESHOLDS.good - 1);

      buildTeamAssignmentsTable();
      buildCategoryTable();
    }

    function saveSettings() {
      const targetRateInput = document.getElementById('target-rate');
      if (targetRateInput) {
        let rateValue = parseInt(targetRateInput.value, 10);
        if (!Number.isFinite(rateValue) || rateValue <= 0) {
          rateValue = 16000;
        }
        targetRateInput.value = rateValue;
        targetRateInput.dispatchEvent(new Event('change'));
      }

      document.querySelectorAll('#team-assignments-body input').forEach(input => {
        const hour = parseInt(input.dataset.teamHour, 10);
        if (Number.isInteger(hour)) {
          const value = input.value.trim();
          TEAM_ASSIGNMENTS[hour] = value || DEFAULT_TEAM_ASSIGNMENTS[hour];
          input.value = TEAM_ASSIGNMENTS[hour];
        }
      });

      let excellent = parseInt(document.getElementById('threshold-excellent').value, 10);
      let good = parseInt(document.getElementById('threshold-good').value, 10);

      if (!Number.isFinite(excellent)) excellent = TRS_THRESHOLDS.excellent;
      if (!Number.isFinite(good)) good = TRS_THRESHOLDS.good;

      excellent = Math.max(0, Math.min(100, excellent));
      good = Math.max(0, Math.min(100, good));

      if (excellent < good) {
        excellent = good;
      }

      TRS_THRESHOLDS.excellent = excellent;
      TRS_THRESHOLDS.good = Math.min(excellent, good);

      document.getElementById('threshold-excellent').value = TRS_THRESHOLDS.excellent;
      document.getElementById('threshold-good').value = TRS_THRESHOLDS.good;
      document.getElementById('threshold-low').value = Math.max(0, TRS_THRESHOLDS.good - 1);

      buildTeamAssignmentsTable();
      refreshDisplay();
      checkBadges();
      showToast('üíæ Param√®tres appliqu√©s', 'success');
    }

    function exportConfig() {
      const config = {
        targetRate: parseInt(document.getElementById('target-rate').value, 10) || 16000,
        teamAssignments: [...TEAM_ASSIGNMENTS],
        thresholds: { ...TRS_THRESHOLDS },
        categories: CATEGORY_DATA.map(item => ({
          category: item.category,
          subcategory: item.subcategory
        }))
      };

      const dateStr = new Date().toISOString().split('T')[0];
      downloadJSON(config, `config-production-${dateStr}.json`);
      showToast('üì§ Configuration export√©e', 'success');
    }

    function importConfig(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const config = JSON.parse(event.target.result);

          if (typeof config.targetRate === 'number' && Number.isFinite(config.targetRate)) {
            const targetRateInput = document.getElementById('target-rate');
            if (targetRateInput) {
              targetRateInput.value = Math.max(0, Math.round(config.targetRate));
              targetRateInput.dispatchEvent(new Event('change'));
            }
          }

          if (Array.isArray(config.teamAssignments) && config.teamAssignments.length === 24) {
            TEAM_ASSIGNMENTS = config.teamAssignments.map((team, index) => {
              const value = typeof team === 'string' ? team.trim() : '';
              return value || DEFAULT_TEAM_ASSIGNMENTS[index];
            });
          }

          if (Array.isArray(config.categories)) {
            CATEGORY_DATA = config.categories.map(item => ({
              category: typeof item.category === 'string' ? item.category.trim() : '',
              subcategory: typeof item.subcategory === 'string' ? item.subcategory.trim() : ''
            }));
            buildCategoryTable();
            rebuildQuickCauses();
          }

          if (config.thresholds && typeof config.thresholds === 'object') {
            const { excellent, good } = config.thresholds;

            if (Number.isFinite(excellent)) {
              TRS_THRESHOLDS.excellent = Math.max(0, Math.min(100, Math.round(excellent)));
            }
            if (Number.isFinite(good)) {
              TRS_THRESHOLDS.good = Math.max(0, Math.min(TRS_THRESHOLDS.excellent, Math.round(good)));
            }

            if (TRS_THRESHOLDS.excellent < TRS_THRESHOLDS.good) {
              TRS_THRESHOLDS.excellent = TRS_THRESHOLDS.good;
            }
          }

          populateParameters();
          refreshDisplay();
          checkBadges();
          showToast('üì• Configuration import√©e', 'success');
        } catch (error) {
          console.error('Erreur import configuration', error);
          showToast('‚ùå Import impossible', 'error');
        }
      };

      reader.readAsText(file);
    }

    function resetDay() {
      hourlyData = createEmptyHourlyData();
      unlockedBadges = new Set();
      document.querySelectorAll('.badge').forEach(badge => badge.classList.remove('unlocked'));
      refreshDisplay();
      checkBadges();
      showToast('üßπ Journ√©e r√©initialis√©e', 'success');
    }

    // Construction de la grille op√©rateur
    function buildHoursGrid() {
      const container = document.getElementById('operator-columns');
      if (!container) return;

      container.innerHTML = '';
      openTileByTeam.clear();

      const teams = getOrderedTeams();
      const currentHour = new Date().getHours();

      teams.forEach(team => {
        const column = createTeamColumn(team, currentHour);
        container.appendChild(column);
      });
    }

    function getOrderedTeams() {
      const ordered = [];
      const seen = new Set();

      TEAM_ORDER.forEach(team => {
        if (team && !seen.has(team)) {
          seen.add(team);
          ordered.push(team);
        }
      });

      TEAM_ASSIGNMENTS.forEach(team => {
        const clean = team || '';
        if (clean && !seen.has(clean)) {
          seen.add(clean);
          ordered.push(clean);
        }
      });

      return ordered;
    }

    function createTeamColumn(team, currentHour) {
      const column = document.createElement('div');
      column.className = 'team-column';
      column.dataset.team = team;

      const teamHours = getTeamHours(team);
      const stats = calculateTeamStats(team, teamHours);

      const header = document.createElement('div');
      header.className = 'team-header';

      const title = document.createElement('div');
      title.className = 'team-title';
      title.innerHTML = `<span>${team}</span><span>${stats.oeeText}</span>`;

      const metrics = document.createElement('div');
      metrics.className = 'team-metrics';
      metrics.innerHTML = `
        <div>
          <span>OEE √©quipe</span>
          <strong>${stats.oeeText}</strong>
        </div>
        <div>
          <span>Heures valid√©es</span>
          <strong>${stats.validated}/${stats.total}</strong>
        </div>
      `;

      const progress = document.createElement('div');
      progress.className = 'team-progress';
      const bar = document.createElement('span');
      bar.style.width = `${Math.min(100, Math.round(stats.ratio * 100))}%`;
      progress.appendChild(bar);

      header.appendChild(title);
      header.appendChild(metrics);
      header.appendChild(progress);

      const hoursWrapper = document.createElement('div');
      hoursWrapper.className = 'team-hours';
      hoursWrapper.dataset.teamHours = team;

      if (teamHours.length === 0) {
        const placeholder = document.createElement('div');
        placeholder.className = 'hour-tile is-empty';
        placeholder.innerHTML = '<div class="tile-placeholder">Aucune heure assign√©e</div>';
        hoursWrapper.appendChild(placeholder);
      } else {
        teamHours.forEach(hour => {
          const tile = createHourTile(hour, team, currentHour);
          hoursWrapper.appendChild(tile);
        });
      }

      column.appendChild(header);
      column.appendChild(hoursWrapper);
      return column;
    }

    function getTeamHours(team) {
      return TEAM_ASSIGNMENTS
        .map((assignment, index) => ({ assignment, index }))
        .filter(item => item.assignment === team)
        .map(item => item.index);
    }

    function calculateTeamStats(team, teamHours) {
      const hours = teamHours.length ? teamHours : Array.from({ length: 24 }, (_, i) => i);
      const validatedData = hours
        .map(hour => hourlyData[hour])
        .filter(data => data && data.validated);

      const validated = validatedData.length;
      const total = hours.length || 24;
      const ratio = total > 0 ? validated / total : 0;

      const oeeAverage = validated > 0
        ? Math.round(validatedData.reduce((sum, data) => sum + calculateComponents(data).oee, 0) / validated)
        : null;

      return {
        validated,
        total,
        ratio,
        oee: oeeAverage,
        oeeText: Number.isFinite(oeeAverage) ? `${oeeAverage}%` : '‚Äî'
      };
    }

    function createHourTile(hour, team, currentHour) {
      if (!hourlyData[hour]) {
        hourlyData[hour] = createEmptyHour(hour);
      }

      const tile = document.createElement('div');
      tile.className = 'hour-tile';
      tile.dataset.hour = hour;
      tile.dataset.team = team;

      if (hour === currentHour) {
        tile.classList.add('is-current');
      }

      const data = hourlyData[hour];

      const summary = document.createElement('div');
      summary.className = 'tile-summary';
      tile.appendChild(summary);

      const historyPanel = renderHistoryPanel(tile);
      tile.appendChild(historyPanel);

      const editor = renderTileEditor(tile, data, team);
      tile.appendChild(editor);

      tile.__summary = summary;
      tile.__historyPanel = historyPanel;
      tile.__team = team;

      updateTileSummary(tile, data, team);

      tile.addEventListener('click', (event) => {
        if (tile.classList.contains('is-editing')) return;
        if (event.target.closest('.tile-actions')) return;
        openTileEditor(tile);
      });

      tile.addEventListener('dblclick', () => {
        openTileEditor(tile, { prefillCadence: true });
      });

      return tile;
    }

    function createEmptyHour(hour) {
      return {
        hour,
        good: 0,
        scrap: 0,
        causes: [],
        comment: '',
        validated: false,
        history: []
      };
    }

    function updateTileSummary(tile, data, team) {
      const summary = tile.__summary;
      if (!summary) return;

      if (!data.validated) {
        tile.classList.add('is-empty');
        tile.classList.remove('is-validated');
        tile.dataset.oeeZone = '';
        summary.innerHTML = `
          <div class="tile-header">
            <div>
              <div class="tile-time">${formatHourRange(data.hour)}</div>
              <div class="tile-team">${team}</div>
            </div>
          </div>
          <div class="tile-placeholder">Cliquez pour saisir</div>
        `;
        return;
      }

      tile.classList.remove('is-empty');
      tile.classList.add('is-validated');

      const components = calculateComponents(data);
      const oee = Math.round(components.oee);
      const availability = Math.round(components.availability * 100);
      const performance = Math.round(components.performance * 100);
      const quality = Math.round(components.quality * 100);
      const downtime = Math.round(components.downtime);

      const zone = getOeeZone(oee);
      tile.dataset.oeeZone = zone || '';

      const badges = [
        `<span class="tile-badge" data-summary-badge="good">Bonne <strong>${(data.good || 0).toLocaleString('fr-FR')}</strong></span>`
      ];

      if (QUALITY_TRACKING) {
        badges.push(`<span class="tile-badge" data-summary-badge="scrap">Rebut <strong>${(data.scrap || 0).toLocaleString('fr-FR')}</strong></span>`);
      }

      badges.push(`<span class="tile-badge" data-summary-badge="downtime">Arr√™ts <strong>${downtime} min</strong></span>`);

      const causes = data.causes && data.causes.length
        ? data.causes.map(cause => {
            const label = [cause.category, cause.subcategory].filter(Boolean).join(' ‚Ä∫ ') || 'Cause';
            return `<span>${label} ‚Ä¢ ${cause.minutes} min</span>`;
          }).join('')
        : '<span>Aucune cause renseign√©e</span>';

      summary.innerHTML = `
        <div class="tile-header">
          <div>
            <div class="tile-time">${formatHourRange(data.hour)}</div>
            <div class="tile-team">${team}</div>
          </div>
          <div class="tile-oee">
            ${oee}%
            <small>D${availability} ¬∑ P${performance} ¬∑ Q${quality}</small>
          </div>
        </div>
        <div class="tile-micro-metrics">${badges.join('')}</div>
        <div class="tile-causes">${causes}</div>
        <div class="tile-actions">
          <button type="button" class="tile-icon-btn" data-action="edit" title="Modifier">‚úèÔ∏è</button>
          <button type="button" class="tile-icon-btn" data-action="history" title="Historique">‚ãØ</button>
        </div>
      `;

      summary.querySelector('[data-action="edit"]').addEventListener('click', (event) => {
        event.stopPropagation();
        openTileEditor(tile);
      });

      summary.querySelector('[data-action="history"]').addEventListener('click', (event) => {
        event.stopPropagation();
        toggleHistoryPanel(tile);
      });

      const quickGood = summary.querySelector('[data-summary-badge="good"]');
      if (quickGood) {
        quickGood.style.cursor = 'pointer';
        quickGood.title = 'Modifier rapidement la production';
        quickGood.addEventListener('click', (event) => {
          event.stopPropagation();
          quickEditGood(tile);
        });
      }
    }

    function getOeeZone(oee) {
      if (!Number.isFinite(oee)) return '';
      if (oee >= TRS_THRESHOLDS.excellent) return 'success';
      if (oee >= TRS_THRESHOLDS.good) return 'warning';
      return 'danger';
    }

    function renderHistoryPanel(tile) {
      const panel = document.createElement('div');
      panel.className = 'history-panel';
      panel.innerHTML = `
        <h4>Historique des modifications</h4>
        <div class="history-list"></div>
        <div class="history-actions">
          <button type="button" data-action="delete-hour">Supprimer cette heure</button>
        </div>
      `;

      panel.querySelector('[data-action="delete-hour"]').addEventListener('click', (event) => {
        event.stopPropagation();
        const hour = parseInt(tile.dataset.hour);
        if (confirm('Supprimer d√©finitivement la saisie de cette heure ?')) {
          deleteHour(hour);
          showToast('üóëÔ∏è Heure supprim√©e', 'success');
        }
      });

      updateHistoryPanel(tile, panel);
      return panel;
    }

    function updateHistoryPanel(tile, panel = tile.__historyPanel) {
      if (!panel) return;
      const list = panel.querySelector('.history-list');
      const hour = parseInt(tile.dataset.hour);
      const history = (hourlyData[hour] && hourlyData[hour].history) || [];

      list.innerHTML = '';

      if (!history.length) {
        const empty = document.createElement('div');
        empty.className = 'tile-placeholder';
        empty.textContent = 'Aucune modification enregistr√©e';
        list.appendChild(empty);
        return;
      }

      history.slice(0, MAX_HISTORY_ENTRIES).forEach(entry => {
        const item = document.createElement('div');
        item.className = 'history-entry';
        const date = new Date(entry.timestamp);
        const details = [`OEE ${entry.oee}%`];
        if (Number.isFinite(entry.good)) {
          details.push(`Bonne ${entry.good.toLocaleString('fr-FR')}`);
        }
        if (QUALITY_TRACKING && Number.isFinite(entry.scrap)) {
          details.push(`Rebut ${entry.scrap.toLocaleString('fr-FR')}`);
        }
        details.push(`Arr√™ts ${entry.downtime} min`);

        item.innerHTML = `
          <div style="font-weight:600;">${date.toLocaleString('fr-FR')}</div>
          <div style="color: var(--text-muted); font-size:0.8rem;">${details.join(' ‚Ä¢ ')}</div>
        `;
        list.appendChild(item);
      });
    }

    function toggleHistoryPanel(tile) {
      const panel = tile.__historyPanel;
      if (!panel) return;

      const isOpen = panel.classList.contains('open');
      document.querySelectorAll('.history-panel.open').forEach(p => p.classList.remove('open'));

      if (!isOpen) {
        updateHistoryPanel(tile, panel);
        panel.classList.add('open');
      }
    }

    function renderTileEditor(tile, data, team) {
      const editor = document.createElement('div');
      editor.className = 'hour-editor';
      editor.dataset.team = team;

      const header = document.createElement('div');
      header.className = 'editor-header';
      header.innerHTML = `
        <h3>${formatHourRange(data.hour)} ‚Ä¢ ${team}</h3>
        <div class="editor-metrics" data-editor-metrics></div>
      `;

      const grid = document.createElement('div');
      grid.className = 'editor-grid';

      const productionBlock = document.createElement('div');
      productionBlock.className = 'editor-block';
      productionBlock.innerHTML = `
        <label>Production bonne (unit√©s)</label>
        <input type="number" min="0" step="100" class="editor-input" data-field="good" />
      `;

      const scrapBlock = document.createElement('div');
      scrapBlock.className = 'editor-block';
      if (QUALITY_TRACKING) {
        scrapBlock.innerHTML = `
          <label>Rebut (unit√©s)</label>
          <input type="number" min="0" step="10" class="editor-input" data-field="scrap" />
        `;
      }

      const availabilityBlock = document.createElement('div');
      availabilityBlock.className = 'editor-block';
      availabilityBlock.innerHTML = `
        <label>Disponibilit√©</label>
        <div class="availability-info" data-availability-info>0 / 60 min</div>
        <div class="availability-bar"><span data-availability-bar></span></div>
        <div class="downtime-warning" data-downtime-warning style="display:none;"></div>
      `;

      grid.appendChild(productionBlock);
      if (QUALITY_TRACKING) {
        grid.appendChild(scrapBlock);
      }
      grid.appendChild(availabilityBlock);

      const causesBlock = document.createElement('div');
      causesBlock.className = 'editor-block';
      causesBlock.innerHTML = `
        <label>Causes d'arr√™t</label>
        <div class="quick-picks" data-quick-picks></div>
        <div class="cause-accordions" data-cause-accordions></div>
      `;

      const commentBlock = document.createElement('div');
      commentBlock.className = 'comment-block';
      commentBlock.innerHTML = `
        <div class="comment-toggle" data-comment-toggle>
          <span>Commentaire</span>
          <small>(cliquer pour d√©rouler)</small>
        </div>
        <textarea class="comment-area" data-comment-area placeholder="Observations, actions..."></textarea>
      `;

      const actions = document.createElement('div');
      actions.className = 'editor-actions';
      actions.innerHTML = `
        <button type="button" class="btn btn-secondary" data-action="cancel">Annuler</button>
        <button type="button" class="btn btn-secondary" data-action="save">üíæ Enregistrer</button>
        <button type="button" class="btn btn-primary" data-action="validate">‚úÖ Valider</button>
      `;

      editor.appendChild(header);
      editor.appendChild(grid);
      editor.appendChild(causesBlock);
      editor.appendChild(commentBlock);
      editor.appendChild(actions);

      tile.__editor = editor;
      tile.__refs = {
        metrics: editor.querySelector('[data-editor-metrics]'),
        goodInput: editor.querySelector('input[data-field="good"]'),
        scrapInput: QUALITY_TRACKING ? editor.querySelector('input[data-field="scrap"]') : null,
        availabilityInfo: editor.querySelector('[data-availability-info]'),
        availabilityBar: editor.querySelector('[data-availability-bar]'),
        downtimeWarning: editor.querySelector('[data-downtime-warning]'),
        quickPicks: editor.querySelector('[data-quick-picks]'),
        causeContainer: editor.querySelector('[data-cause-accordions]'),
        commentToggle: editor.querySelector('[data-comment-toggle]'),
        commentArea: editor.querySelector('[data-comment-area]'),
        actions,
        header
      };

      setupEditorInteractions(tile, data);

      return editor;
    }

    function setupEditorInteractions(tile, data) {
      const refs = tile.__refs;
      const state = cloneHourData(data);
      tile.__state = state;
      tile.__original = cloneHourData(data);

      refs.goodInput.value = state.good || 0;
      refs.goodInput.addEventListener('input', () => {
        state.good = Math.max(0, parseInt(refs.goodInput.value, 10) || 0);
        updateEditorFromState(tile);
      });

      if (refs.scrapInput) {
        refs.scrapInput.value = state.scrap || 0;
        refs.scrapInput.addEventListener('input', () => {
          state.scrap = Math.max(0, parseInt(refs.scrapInput.value, 10) || 0);
          updateEditorFromState(tile);
        });
      }

      refs.commentArea.value = state.comment || '';
      refs.commentToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        refs.commentArea.classList.toggle('open');
      });

      refs.commentArea.addEventListener('input', () => {
        state.comment = refs.commentArea.value;
      });

      refs.actions.querySelector('[data-action="cancel"]').addEventListener('click', (event) => {
        event.stopPropagation();
        closeTileEditor(tile, true);
      });

      refs.actions.querySelector('[data-action="save"]').addEventListener('click', (event) => {
        event.stopPropagation();
        persistTileState(tile, { validate: false });
      });

      refs.actions.querySelector('[data-action="validate"]').addEventListener('click', (event) => {
        event.stopPropagation();
        persistTileState(tile, { validate: true });
      });

      buildCauseAccordions(tile);
      populateQuickPicks(refs.quickPicks, tile, state);
      updateEditorFromState(tile);

      refs.causeContainer.addEventListener('keydown', (event) => {
        if (!tile.classList.contains('is-editing')) return;
        const row = event.target.closest('.cause-row');
        if (!row) return;
        const category = row.dataset.category;
        const subcategory = row.dataset.subcategory;

        if (event.key === '+' || event.key === '=' || event.key === 'Add') {
          event.preventDefault();
          updateCauseMinutes(tile, state, category, subcategory, CAUSE_STEP);
        }
        if (event.key === '-' || event.key === '_' || event.key === 'Subtract') {
          event.preventDefault();
          updateCauseMinutes(tile, state, category, subcategory, -CAUSE_STEP);
        }
      });
    }

    function buildCauseAccordions(tile) {
      const refs = tile.__refs;
      const state = tile.__state;
      const container = refs.causeContainer;
      container.innerHTML = '';

      const grouped = CATEGORY_DATA.reduce((acc, item) => {
        const category = item.category || 'Autres';
        if (!acc[category]) acc[category] = [];
        if (item.subcategory && !acc[category].includes(item.subcategory)) {
          acc[category].push(item.subcategory);
        }
        if (!item.subcategory && !acc[category].length) {
          acc[category].push('');
        }
        return acc;
      }, {});

      Object.keys(grouped).forEach(category => {
        const accordion = document.createElement('div');
        accordion.className = 'cause-accordion';

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'accordion-header';
        header.innerHTML = `<span>${category}</span><span>${grouped[category].length} sous-cat√©gories</span>`;

        const content = document.createElement('div');
        content.className = 'accordion-content';

        header.addEventListener('click', (event) => {
          event.stopPropagation();
          const isOpen = content.classList.contains('open');
          container.querySelectorAll('.accordion-content.open').forEach(el => el.classList.remove('open'));
          if (!isOpen) {
            content.classList.add('open');
          }
        });

        grouped[category].forEach(subcategory => {
          const row = document.createElement('div');
          row.className = 'cause-row';
          row.dataset.category = category;
          row.dataset.subcategory = subcategory;

          const label = [category, subcategory].filter(Boolean).join(' ‚Ä∫ ') || category;
          const existing = state.causes.find(c => c.category === category && c.subcategory === subcategory);
          const minutes = existing ? existing.minutes : 0;

          row.innerHTML = `
            <span>${label}</span>
            <div class="cause-controls">
              <button type="button" class="cause-button" data-action="decrement">‚àí5</button>
              <div class="cause-counter" tabindex="0">${minutes}</div>
              <button type="button" class="cause-button" data-action="increment">+5</button>
            </div>
          `;

          const minusBtn = row.querySelector('[data-action="decrement"]');
          const plusBtn = row.querySelector('[data-action="increment"]');

          minusBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (minusBtn.dataset.longPressTriggered === 'true') {
              minusBtn.dataset.longPressTriggered = 'false';
              return;
            }
            updateCauseMinutes(tile, state, category, subcategory, -CAUSE_STEP);
          });

          plusBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (plusBtn.dataset.longPressTriggered === 'true') {
              plusBtn.dataset.longPressTriggered = 'false';
              return;
            }
            updateCauseMinutes(tile, state, category, subcategory, CAUSE_STEP);
          });

          attachLongPress(minusBtn, () => updateCauseMinutes(tile, state, category, subcategory, -CAUSE_LONG_STEP));
          attachLongPress(plusBtn, () => updateCauseMinutes(tile, state, category, subcategory, CAUSE_LONG_STEP));

          content.appendChild(row);
        });

        accordion.appendChild(header);
        accordion.appendChild(content);
        container.appendChild(accordion);
      });
    }

    function attachLongPress(button, callback) {
      let timer = null;

      const start = () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          button.dataset.longPressTriggered = 'true';
          callback();
        }, CAUSE_LONG_DELAY);
      };

      const clear = () => {
        clearTimeout(timer);
        timer = null;
      };

      button.addEventListener('mousedown', start);
      button.addEventListener('touchstart', start, { passive: true });
      button.addEventListener('mouseup', clear);
      button.addEventListener('mouseleave', clear);
      button.addEventListener('touchend', clear);
      button.addEventListener('touchcancel', clear);
    }

    function populateQuickPicks(container, tile, state) {
      if (!container) return;
      container.innerHTML = '';

      const filtered = recentSubcategories.filter(entry =>
        CATEGORY_DATA.some(item => item.category === entry.category && item.subcategory === entry.subcategory)
      );

      if (!filtered.length) {
        const placeholder = document.createElement('div');
        placeholder.className = 'tile-placeholder';
        placeholder.textContent = 'Aucune s√©lection r√©cente';
        container.appendChild(placeholder);
        return;
      }

      filtered.forEach(entry => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'quick-pick';
        const label = [entry.category, entry.subcategory].filter(Boolean).join(' ‚Ä∫ ');
        btn.textContent = label;
        btn.addEventListener('click', (event) => {
          event.stopPropagation();
          updateCauseMinutes(tile, state, entry.category, entry.subcategory, CAUSE_STEP);
        });
        container.appendChild(btn);
      });
    }

    function updateRecentSubcategories(category, subcategory) {
      if (!subcategory) return;
      const key = `${category}|||${subcategory}`;
      recentSubcategories = [
        { category, subcategory, key },
        ...recentSubcategories.filter(item => item.key !== key)
      ].slice(0, 8);
      rebuildQuickCauses();
    }

    function updateCauseMinutes(tile, state, category, subcategory, delta) {
      const existing = state.causes.find(cause => cause.category === category && cause.subcategory === subcategory);
      const currentMinutes = existing ? existing.minutes : 0;
      const proposed = Math.max(0, currentMinutes + delta);

      const totalWithout = state.causes.reduce((sum, cause) => sum + (cause.minutes || 0), 0) - currentMinutes + proposed;

      if (totalWithout > 60) {
        showToast('‚è±Ô∏è Maximum 60 minutes d\'arr√™t', 'error');
        return false;
      }

      if (proposed === 0) {
        state.causes = state.causes.filter(cause => !(cause.category === category && cause.subcategory === subcategory));
      } else if (existing) {
        existing.minutes = proposed;
      } else {
        state.causes.push({
          id: `${category}-${subcategory}`,
          category,
          subcategory,
          minutes: proposed
        });
      }

      if (proposed > 0 && delta > 0) {
        updateRecentSubcategories(category, subcategory);
      }

      updateEditorFromState(tile);
      return true;
    }

    function updateEditorFromState(tile) {
      const refs = tile.__refs;
      const state = tile.__state;
      if (!refs || !state) return;

      const totalDowntime = state.causes.reduce((sum, cause) => sum + (cause.minutes || 0), 0);
      const components = calculateComponents(state);

      refs.metrics.innerHTML = `
        <span>OEE ${Math.round(components.oee)}%</span>
        <span>D ${Math.round(components.availability * 100)}%</span>
        <span>P ${Math.round(components.performance * 100)}%</span>
        <span>Q ${Math.round(components.quality * 100)}%</span>
      `;

      refs.availabilityInfo.textContent = `${Math.round(totalDowntime)} min / 60`;

      const barWidth = Math.max(0, Math.min(100, ((60 - totalDowntime) / 60) * 100));
      refs.availabilityBar.style.width = `${barWidth}%`;
      refs.availabilityBar.style.background = getDowntimeColor(totalDowntime);

      const validateBtn = refs.actions.querySelector('[data-action="validate"]');
      const saveBtn = refs.actions.querySelector('[data-action="save"]');
      const exceeds = totalDowntime > 60;

      refs.downtimeWarning.style.display = exceeds ? '' : 'none';
      refs.downtimeWarning.textContent = exceeds ? 'Limite de 60 minutes d√©pass√©e' : '';

      if (validateBtn) validateBtn.disabled = exceeds;
      if (saveBtn) saveBtn.disabled = exceeds;

      refs.causeContainer.querySelectorAll('.cause-row').forEach(row => {
        const minutes = state.causes.find(cause => cause.category === row.dataset.category && cause.subcategory === row.dataset.subcategory);
        const counter = row.querySelector('.cause-counter');
        if (counter) {
          counter.textContent = minutes ? minutes.minutes : 0;
        }
      });

      populateQuickPicks(refs.quickPicks, tile, state);
      updateTileSummaryFromState(tile);
    }

    function getDowntimeColor(minutes) {
      if (minutes < 15) return 'linear-gradient(90deg, rgba(16,185,129,0.8), rgba(56,189,248,0.8))';
      if (minutes < 30) return 'linear-gradient(90deg, rgba(245,158,11,0.8), rgba(249,115,22,0.8))';
      return 'linear-gradient(90deg, rgba(239,68,68,0.8), rgba(248,113,113,0.8))';
    }

    function updateTileSummaryFromState(tile) {
      const state = tile.__state;
      if (!state || !tile.classList.contains('is-editing')) return;
      const preview = cloneHourData(state);
      preview.validated = true;
      updateTileSummary(tile, preview, tile.__team);
    }

    function formatHourRange(hour) {
      const start = String(hour).padStart(2, '0');
      const end = String((hour + 1) % 24).padStart(2, '0');
      return `${start}h-${end}h`;
    }

    function openTileEditor(tile, options = {}) {
      if (!tile || tile.classList.contains('is-editing')) return;
      const team = tile.dataset.team;
      const currentlyOpen = openTileByTeam.get(team);
      if (currentlyOpen && currentlyOpen !== tile) {
        const closed = closeTileEditor(currentlyOpen);
        if (!closed) {
          return;
        }
      }

      openTileByTeam.set(team, tile);
      tile.classList.add('is-editing');
      tile.classList.remove('is-empty');

      const state = tile.__state || cloneHourData(hourlyData[parseInt(tile.dataset.hour)] || createEmptyHour(parseInt(tile.dataset.hour)));
      tile.__state = state;
      tile.__original = cloneHourData(hourlyData[parseInt(tile.dataset.hour)] || createEmptyHour(parseInt(tile.dataset.hour)));

      if (options.prefillCadence) {
        const targetRate = parseInt(document.getElementById('target-rate').value) || 16000;
        if (!state.good) {
          state.good = targetRate;
        }
      }

      updateEditorFromState(tile);
      const refs = tile.__refs;
      if (refs && refs.goodInput) {
        setTimeout(() => refs.goodInput.focus(), 0);
      }

      document.querySelectorAll('.history-panel.open').forEach(panel => panel.classList.remove('open'));
    }

    function closeTileEditor(tile, force = false) {
      if (!tile || !tile.classList.contains('is-editing')) return true;

      const stateChanged = hasStateChanged(tile);
      if (stateChanged && !force) {
        const shouldSave = confirm('Des modifications non enregistr√©es. Voulez-vous les enregistrer ?');
        if (shouldSave) {
          const saved = persistTileState(tile, { validate: false, stayOpen: false });
          return saved;
        }
      }

      tile.classList.remove('is-editing');
      const team = tile.dataset.team;
      if (openTileByTeam.get(team) === tile) {
        openTileByTeam.delete(team);
      }

      const original = tile.__original || cloneHourData(hourlyData[parseInt(tile.dataset.hour)] || createEmptyHour(parseInt(tile.dataset.hour)));
      tile.__state = cloneHourData(original);
      updateTileSummary(tile, original, tile.__team);

      if (tile.__refs) {
        tile.__refs.downtimeWarning.style.display = 'none';
      }

      return true;
    }

    function hasStateChanged(tile) {
      const state = tile.__state;
      const original = tile.__original;
      if (!state || !original) return false;

      const normalize = (entry) => ({
        good: entry.good || 0,
        scrap: entry.scrap || 0,
        comment: entry.comment || '',
        causes: (entry.causes || []).map(cause => ({
          category: cause.category,
          subcategory: cause.subcategory,
          minutes: cause.minutes || 0
        })).sort((a, b) => (a.category + a.subcategory).localeCompare(b.category + b.subcategory))
      });

      const a = normalize(state);
      const b = normalize(original);

      if (a.good !== b.good || a.scrap !== b.scrap || a.comment !== b.comment) return true;
      if (a.causes.length !== b.causes.length) return true;
      for (let i = 0; i < a.causes.length; i++) {
        if (a.causes[i].category !== b.causes[i].category || a.causes[i].subcategory !== b.causes[i].subcategory || a.causes[i].minutes !== b.causes[i].minutes) {
          return true;
        }
      }

      return false;
    }

    function cloneHourData(data) {
      if (!data) return null;
      return {
        hour: data.hour,
        good: data.good || 0,
        scrap: data.scrap || 0,
        causes: (data.causes || []).map(cause => ({
          id: cause.id || `${cause.category}-${cause.subcategory}`,
          category: cause.category || '',
          subcategory: cause.subcategory || '',
          minutes: cause.minutes || 0
        })),
        comment: data.comment || '',
        validated: Boolean(data.validated),
        history: Array.isArray(data.history) ? data.history.map(entry => ({ ...entry })) : []
      };
    }

    function persistTileState(tile, { validate = false, stayOpen } = {}) {
      const state = tile.__state;
      if (!state) return false;

      const totalDowntime = state.causes.reduce((sum, cause) => sum + (cause.minutes || 0), 0);
      if (totalDowntime > 60) {
        showToast('‚è±Ô∏è Limite de 60 minutes d√©pass√©e', 'error');
        return false;
      }

      const hour = parseInt(tile.dataset.hour);
      const previous = cloneHourData(hourlyData[hour] || createEmptyHour(hour));

      const newEntry = {
        hour,
        good: Math.max(0, Math.round(state.good || 0)),
        scrap: Math.max(0, Math.round(state.scrap || 0)),
        causes: state.causes.filter(cause => cause.minutes > 0).map(cause => ({
          id: cause.id || `${cause.category}-${cause.subcategory}`,
          category: cause.category,
          subcategory: cause.subcategory,
          minutes: cause.minutes
        })),
        comment: state.comment || '',
        validated: validate ? true : (state.validated || previous.validated || false),
        history: Array.isArray(previous.history) ? [...previous.history] : [],
        timestamp: new Date().toISOString()
      };

      const historyEntry = recordEdit(hour, previous, newEntry, validate ? 'validation' : 'save');
      newEntry.history = [historyEntry, ...newEntry.history].slice(0, MAX_HISTORY_ENTRIES);

      hourlyData[hour] = newEntry;
      tile.__original = cloneHourData(newEntry);
      tile.__state = cloneHourData(newEntry);

      if (stayOpen === undefined) {
        stayOpen = !validate;
      }

      updateKPIs();
      updateChart();
      checkBadges();

      const targetRate = parseInt(document.getElementById('target-rate').value) || 16000;
      celebrate(newEntry.good >= targetRate && validate);

      if (stayOpen) {
        updateEditorFromState(tile);
        showToast(validate ? '‚úÖ Heure valid√©e' : 'üíæ Modifications enregistr√©es', 'success');
        return true;
      }

      showToast(validate ? '‚úÖ Heure valid√©e' : 'üíæ Modifications enregistr√©es', 'success');
      refreshDisplay();
      return true;
    }

    function recordEdit(hour, previous, next, action = 'update') {
      const components = calculateComponents(next);
      const entry = {
        hour,
        action,
        timestamp: new Date().toISOString(),
        good: next.good || 0,
        scrap: next.scrap || 0,
        downtime: Math.round(components.downtime),
        oee: Math.round(components.oee)
      };

      edits.unshift(entry);
      if (edits.length > 200) {
        edits.length = 200;
      }

      return entry;
    }

    function deleteHour(hour) {
      const previous = cloneHourData(hourlyData[hour]);
      hourlyData[hour] = createEmptyHour(hour);
      recordEdit(hour, previous, hourlyData[hour], 'delete');
      refreshDisplay();
      updateKPIs();
      updateChart();
      checkBadges();
    }

    function highlightCurrentHour() {
      const currentHour = new Date().getHours();
      document.querySelectorAll('.hour-tile').forEach(tile => {
        const hour = parseInt(tile.dataset.hour);
        tile.classList.toggle('is-current', hour === currentHour);
      });
    }

    function handleDocumentClick(event) {
      const tile = event.target.closest('.hour-tile');
      if (!tile) {
        document.querySelectorAll('.history-panel.open').forEach(panel => panel.classList.remove('open'));
        Array.from(openTileByTeam.values()).forEach(openTile => {
          closeTileEditor(openTile);
        });
      }
    }

    function quickEditGood(tile) {
      const hour = parseInt(tile.dataset.hour);
      const current = cloneHourData(hourlyData[hour] || createEmptyHour(hour));
      const input = prompt('Nouvelle production bonne ?', current.good || 0);
      if (input === null) return;

      const good = Math.max(0, parseInt(input, 10) || 0);
      if (good === current.good) return;

      const updated = {
        ...current,
        good,
        validated: true,
        timestamp: new Date().toISOString()
      };

      const historyEntry = recordEdit(hour, current, updated, 'inline-good');
      updated.history = [historyEntry, ...(current.history || [])].slice(0, MAX_HISTORY_ENTRIES);

      hourlyData[hour] = updated;

      refreshDisplay();
      updateKPIs();
      updateChart();
      checkBadges();

      const targetRate = parseInt(document.getElementById('target-rate').value) || 16000;
      celebrate(updated.good >= targetRate);
      showToast('‚úèÔ∏è Production mise √† jour', 'success');
    }


    // Actualisation de l'affichage
    function refreshDisplay() {
      buildHoursGrid();
      highlightCurrentHour();
      updateKPIs();
      updateChart();
    }

    // KPIs
    function updateKPIs() {
      const validatedData = hourlyData.filter(d => d.validated);

      if (validatedData.length === 0) {
        document.getElementById('kpi-trs').textContent = '0%';
        document.getElementById('kpi-availability').textContent = '0%';
        document.getElementById('kpi-performance').textContent = '0%';
        document.getElementById('kpi-total').textContent = '0';
        return;
      }

      let totalAvail = 0, totalPerf = 0, totalQuality = 0;
      let totalProduction = 0;

      validatedData.forEach(data => {
        const components = calculateComponents(data);
        totalAvail += components.availability;
        totalPerf += components.performance;
        totalQuality += components.quality;
        totalProduction += data.good || 0;
      });

      const avgAvail = totalAvail / validatedData.length;
      const avgPerf = totalPerf / validatedData.length;
      const avgQuality = totalQuality / validatedData.length;
      const trs = avgAvail * avgPerf * avgQuality;

      document.getElementById('kpi-trs').textContent = `${Math.round(trs * 100)}%`;
      document.getElementById('kpi-availability').textContent = `${Math.round(avgAvail * 100)}%`;
      document.getElementById('kpi-performance').textContent = `${Math.round(avgPerf * 100)}%`;
      document.getElementById('kpi-total').textContent = totalProduction.toLocaleString('fr-FR');

      // Mise √† jour de la tendance
      const targetDaily = 24 * (parseInt(document.getElementById('target-rate').value) || 16000);
      document.getElementById('target-trend').innerHTML = `
        <span>${totalProduction >= targetDaily ? '‚Üó' : '‚Üí'}</span>
        Objectif: ${(targetDaily / 1000).toFixed(0)}k
      `;
    }

    function calculateComponents(data) {
      const targetRate = parseInt(document.getElementById('target-rate').value) || 16000;
      const good = data.good || 0;
      const scrap = QUALITY_TRACKING ? (data.scrap || 0) : 0;
      const produced = good + scrap;
      const downtime = (data.causes || []).reduce((sum, cause) => sum + (cause.minutes || 0), 0);

      const availability = Math.max(0, Math.min(1, (60 - downtime) / 60));
      const performance = targetRate > 0 ? Math.min(1, good / targetRate) : 0;
      const quality = QUALITY_TRACKING ? (produced > 0 ? good / produced : 1) : 1;
      const oee = availability * performance * quality * 100;

      return { availability, performance, quality, oee, downtime };
    }

    function calculateTRS(data) {
      return Math.round(calculateComponents(data).oee);
    }

    // Graphique Chart.js
    function initChart() {
      const ctx = document.getElementById('production-chart').getContext('2d');
      
      currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}h`),
          datasets: [
            {
              label: 'Production R√©elle',
              data: Array(24).fill(0),
              backgroundColor: 'rgba(99, 102, 241, 0.6)',
              borderColor: 'rgba(99, 102, 241, 1)',
              borderWidth: 2,
              borderRadius: 8
            },
            {
              label: 'Cible',
              data: Array(24).fill(16000),
              type: 'line',
              borderColor: 'rgba(245, 158, 11, 1)',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 3,
              pointRadius: 0,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#f1f5f9',
                font: { size: 14, weight: 600 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(30, 41, 59, 0.95)',
              titleColor: '#f1f5f9',
              bodyColor: '#f1f5f9',
              borderColor: 'rgba(99, 102, 241, 0.5)',
              borderWidth: 1,
              padding: 12,
              displayColors: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              },
              ticks: {
                color: '#94a3b8'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#94a3b8'
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    function updateChart() {
      if (!currentChart) return;

      try {
        const targetRate = parseInt(document.getElementById('target-rate').value) || 16000;
        const productionData = hourlyData.map(d => d.validated ? d.good : 0);

        currentChart.data.datasets[0].data = productionData;
        currentChart.data.datasets[1].data = Array(24).fill(targetRate);
        currentChart.update();
      } catch (error) {
        console.error('Erreur mise √† jour graphique', error);
      }
    }

    // Syst√®me de badges
    function checkBadges() {
      const validatedData = hourlyData.filter(d => d.validated);
      
      // Badge: Heure Parfaite (TRS >= 100%)
      validatedData.forEach(data => {
        if (calculateTRS(data) >= 100) {
          unlockBadge('perfect-hour');
        }
      });
      
      // Badge: Z√©ro Arr√™t
      validatedData.forEach(data => {
        const downtime = data.causes.reduce((sum, c) => sum + (c.minutes || 0), 0);
        if (downtime === 0) {
          unlockBadge('zero-downtime');
        }
      });
      
      // Badge: Streak (3 heures cons√©cutives >= 90%)
      let streak = 0;
      for (let i = 0; i < 24; i++) {
        if (hourlyData[i].validated && calculateTRS(hourlyData[i]) >= 90) {
          streak++;
          if (streak >= 3) {
            unlockBadge('streak-3');
            break;
          }
        } else {
          streak = 0;
        }
      }
      
      // Badge: Champion √âquipe (moyenne √©quipe > 95%)
      const teams = {};
      validatedData.forEach(data => {
        const team = TEAM_ASSIGNMENTS[data.hour];
        if (!teams[team]) teams[team] = [];
        teams[team].push(calculateTRS(data));
      });
      
      Object.values(teams).forEach(trsList => {
        const avg = trsList.reduce((a, b) => a + b, 0) / trsList.length;
        if (avg >= 95) {
          unlockBadge('team-champion');
        }
      });
      
      // Badge: R√©gularit√© (√©cart-type faible)
      if (validatedData.length >= 8) {
        const trsList = validatedData.map(d => calculateTRS(d));
        const avg = trsList.reduce((a, b) => a + b, 0) / trsList.length;
        const variance = trsList.reduce((sum, trs) => sum + Math.pow(trs - avg, 2), 0) / trsList.length;
        const stdDev = Math.sqrt(variance);
        
        if (stdDev < 5) {
          unlockBadge('consistency');
        }
      }
    }

    function unlockBadge(badgeId) {
      if (unlockedBadges.has(badgeId)) return;
      
      unlockedBadges.add(badgeId);
      const badge = document.querySelector(`[data-badge="${badgeId}"]`);
      if (badge) {
        badge.classList.add('unlocked');
        showToast(`üèÜ Badge d√©bloqu√©: ${badge.querySelector('.badge-label').textContent}`, 'success');
      }
    }

    // C√©l√©bration
    function celebrate(isExcellent) {
      if (!isExcellent) return;
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          createConfetti();
        }, i * 30);
      }
    }

    function createConfetti() {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * window.innerWidth + 'px';
      confetti.style.top = '-10px';
      confetti.style.background = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'][Math.floor(Math.random() * 5)];
      confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
      document.body.appendChild(confetti);
      
      setTimeout(() => confetti.remove(), 3000);
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
    document.getElementById('import-config-btn').addEventListener('click', () => {
      document.getElementById('config-import-input').click();
    });

    document.getElementById('config-import-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      importConfig(file);
      event.target.value = '';
    });

    document.getElementById('export-config-btn').addEventListener('click', exportConfig);
    document.getElementById('reset-day-btn').addEventListener('click', resetDay);
    document.getElementById('add-category-row-btn').addEventListener('click', addCategoryRow);
    document.getElementById('save-categories-btn').addEventListener('click', saveCategoriesList);
    document.getElementById('export-categories-btn').addEventListener('click', exportCategories);
    document.getElementById('import-categories-btn').addEventListener('click', () => {
      document.getElementById('categories-import-input').click();
    });
    document.getElementById('categories-import-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      importCategories(file);
      event.target.value = '';
    });

    // Boutons d'action
    document.getElementById('refresh-btn').addEventListener('click', () => {
      refreshDisplay();
      showToast('üîÑ Donn√©es actualis√©es', 'success');
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      const csvData = generateCSV();
      downloadCSV(csvData, getCSVFilename());
      showToast('üìä Export r√©ussi', 'success');
    });

    function generateCSV() {
      const rows = [['Heure', '√âquipe', 'Production', 'TRS%', 'Commentaire']];

      hourlyData.forEach(data => {
        if (data.validated) {
          rows.push([
            `${String(data.hour).padStart(2, '0')}:00`,
            TEAM_ASSIGNMENTS[data.hour],
            data.good,
            calculateTRS(data),
            data.comment || ''
          ]);
        }
      });
      
      return rows.map(row => row.join(';')).join('\n');
    }

    function getCSVFilename() {
      const dateStr = new Date().toISOString().split('T')[0];
      return `production-${dateStr}.csv`;
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      setTimeout(() => URL.revokeObjectURL(link.href), 100);
    }

    function downloadJSON(content, filename) {
      const blob = new Blob([JSON.stringify(content, null, 2)], { type: 'application/json;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      setTimeout(() => URL.revokeObjectURL(link.href), 100);
    }

    function buildCategoryTable() {
      const tbody = document.getElementById('categories-table-body');
      if (!tbody) return;

      tbody.innerHTML = '';

      CATEGORY_DATA.forEach((item, index) => {
        const row = document.createElement('tr');

        const categoryCell = document.createElement('td');
        const categoryInput = document.createElement('input');
        categoryInput.type = 'text';
        categoryInput.value = item.category || '';
        categoryInput.dataset.field = 'category';
        categoryCell.appendChild(categoryInput);

        const subcategoryCell = document.createElement('td');
        const subcategoryInput = document.createElement('input');
        subcategoryInput.type = 'text';
        subcategoryInput.value = item.subcategory || '';
        subcategoryInput.dataset.field = 'subcategory';
        subcategoryCell.appendChild(subcategoryInput);

        const actionsCell = document.createElement('td');
        actionsCell.style.whiteSpace = 'nowrap';
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-secondary';
        deleteBtn.textContent = 'üóëÔ∏è Supprimer';
        deleteBtn.addEventListener('click', () => removeCategoryRow(index));
        actionsCell.appendChild(deleteBtn);

        row.appendChild(categoryCell);
        row.appendChild(subcategoryCell);
        row.appendChild(actionsCell);

        tbody.appendChild(row);
      });
    }

    function getCategoriesFromTable() {
      const rows = document.querySelectorAll('#categories-table-body tr');
      if (!rows.length) {
        return [...CATEGORY_DATA];
      }

      return Array.from(rows).map(row => {
        const categoryInput = row.querySelector('input[data-field="category"]');
        const subcategoryInput = row.querySelector('input[data-field="subcategory"]');
        return {
          category: categoryInput ? categoryInput.value.trim() : '',
          subcategory: subcategoryInput ? subcategoryInput.value.trim() : ''
        };
      });
    }

    function addCategoryRow() {
      CATEGORY_DATA = getCategoriesFromTable();
      CATEGORY_DATA.push({ category: '', subcategory: '' });
      buildCategoryTable();
    }

    function removeCategoryRow(index) {
      const current = getCategoriesFromTable();
      CATEGORY_DATA = current.filter((_, idx) => idx !== index);
      buildCategoryTable();
      rebuildQuickCauses();
    }

    function saveCategoriesList() {
      CATEGORY_DATA = getCategoriesFromTable().map(item => ({
        category: item.category,
        subcategory: item.subcategory
      }));
      buildCategoryTable();
      rebuildQuickCauses();
      showToast('üíæ Cat√©gories enregistr√©es', 'success');
    }

    function exportCategories() {
      CATEGORY_DATA = getCategoriesFromTable();
      downloadJSON({ categories: CATEGORY_DATA }, 'categories.json');
      showToast('üì§ Cat√©gories export√©es', 'success');
    }

    function importCategories(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const parsed = JSON.parse(event.target.result);
          const categories = Array.isArray(parsed)
            ? parsed
            : (Array.isArray(parsed.categories) ? parsed.categories : null);

          if (!categories) {
            throw new Error('Format cat√©gories invalide');
          }

          CATEGORY_DATA = categories.map(item => ({
            category: typeof item.category === 'string' ? item.category.trim() : '',
            subcategory: typeof item.subcategory === 'string' ? item.subcategory.trim() : ''
          }));

          buildCategoryTable();
          rebuildQuickCauses();
          showToast('üì• Cat√©gories import√©es', 'success');
        } catch (error) {
          console.error('Erreur import cat√©gories', error);
          showToast('‚ùå Import cat√©gories impossible', 'error');
        }
      };

      reader.readAsText(file);
    }

    function rebuildQuickCauses() {
      recentSubcategories = recentSubcategories.filter(entry =>
        CATEGORY_DATA.some(item => item.category === entry.category && item.subcategory === entry.subcategory)
      );

      document.querySelectorAll('.hour-tile .quick-picks').forEach(container => {
        const tile = container.closest('.hour-tile');
        if (tile && tile.__state) {
          populateQuickPicks(container, tile, tile.__state);
        }
      });
    }

    // Mise √† jour cadence cible
    document.getElementById('target-rate').addEventListener('change', () => {
      refreshDisplay();
    });

    bump('minor', ['Nouvelle interface op√©rateur 3 colonnes + accord√©ons multi-causes']);
  </script>
</body>
</html>
